<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        (function() {
            const savedTheme = localStorage.getItem('dashboard-theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
        })();
    </script>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net https://cdnjs.cloudflare.com; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://*.supabase.co; font-src 'self' data:;">
    <title>SteadyManager - Dashboard</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

    <!-- Theme System -->
    <link rel="stylesheet" href="/dashboard/shared/css/themes.css">

    <style>
        /* All theme colors and variables are defined in /dashboard/shared/css/themes.css */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }

        input, textarea, [contenteditable] {
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
        }

        html, body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            background: var(--sidebar-bg);
            color: var(--sidebar-text);
            z-index: 1000;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }

        .sidebar-content {
            padding: 2rem 0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 0 1.5rem 2rem;
            border-bottom: 2px solid var(--hover-overlay-light);
            margin-bottom: 2rem;
        }

        .sidebar-logo {
            font-size: 1.75rem;
            font-weight: 900;
            text-align: center;
            color: var(--sidebar-text);
            text-shadow: var(--shadow);
        }

        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin-bottom: auto;
            flex: 1;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: var(--sidebar-text-secondary);
            text-decoration: none;
            transition: var(--transition);
            font-weight: 500;
            cursor: pointer;
            margin: 0 0.75rem;
            border-radius: var(--radius);
        }

        .nav-link:hover {
            background: var(--sidebar-item-hover);
            color: var(--sidebar-text);
            transform: translateX(8px);
        }

        .nav-link.active {
            background: var(--sidebar-item-active);
            color: var(--sidebar-text);
            font-weight: 600;
            transform: translateX(8px);
        }

        .nav-icon {
            width: 20px;
            height: 20px;
            stroke-width: 2;
        }

        .main-content {
            margin-left: 280px;
            height: 100vh;
            background: var(--background);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .page-content {
            display: none;
        }

        .page-content.active {
            display: block;
        }

        .header {
            background: var(--surface);
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            height: 80px;
            flex-shrink: 0;
            z-index: 100;
        }

        .header-title {
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--text-primary);
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            cursor: pointer;
            padding: 0.5rem 1.5rem 0.5rem 1rem;
            border-radius: var(--radius-lg);
            transition: var(--transition);
            border: 2px solid transparent;
            position: relative;
            display: inline-block;
        }

        .header-title::before {
            content: 'â›¶';
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            opacity: 0;
            transition: all 0.3s ease;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-title:hover {
            border: 2px solid var(--primary);
            box-shadow: 0 0 20px var(--job-btn-shadow-hover);
            transform: scale(1.05);
            padding-right: 2.5rem;
        }

        .header-title:hover::before {
            opacity: 1;
        }

        .header-title:active {
            transform: scale(0.98);
        }

        .user-menu-container {
            position: relative;
            z-index: 999999;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--surface-hover);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border);
        }

        .user-menu:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .user-tier {
            font-size: 0.75rem;
            color: var(--primary);
            font-weight: 500;
        }

        .dashboard-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background: var(--background);
        }

        .content-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .sidebar.desktop-hidden {
            transform: translateX(-100%);
        }
        
        .main-content.sidebar-hidden {
            margin-left: 0;
        }

        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Module Loading State */
        .module-loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 280px;
            right: 0;
            bottom: 0;
            background: var(--background);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }

        .module-loading-overlay.active {
            display: flex;
        }

        .module-loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 1s linear infinite;
            margin-bottom: 1rem;
        }

        .module-loading-text {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .page-content {
            position: relative;
            min-height: 400px;
        }

        @media (max-width: 1024px) {
            .module-loading-overlay {
                left: 0;
            }
        }
    </style>
</head>
<body>
    <div class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <div class="sidebar-header">
                <div class="sidebar-logo">SteadyManager</div>
            </div>

            <nav>
                <ul class="sidebar-nav" id="sidebar-nav">
                    <!-- Dynamically generated based on modules_selected -->
                </ul>
            </nav>
        </div>
    </div>

    <div class="main-content">
        <header class="header">
            <h1 class="header-title" id="pageTitle">Dashboard</h1>
            
            <div class="user-menu-container">
                <div class="user-menu" id="userMenu">
                    <div class="user-avatar" id="userAvatar">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Loading...</div>
                        <div class="user-tier" id="userTier">Professional</div>
                    </div>
                </div>
            </div>
        </header>

        <main class="dashboard-content">
            <div class="content-container">
                <div id="dashboard-content" class="page-content active"></div>
                <div id="leads-content" class="page-content"></div>
                <div id="pipeline-content" class="page-content"></div>
                <div id="tasks-content" class="page-content"></div>
                <div id="jobs-content" class="page-content"></div>
                <div id="goals-content" class="page-content"></div>
                <div id="estimates-content" class="page-content"></div>
                <div id="notes-content" class="page-content"></div>
                <div id="settings-content" class="page-content"></div>
                <div id="module-market-content" class="page-content"></div>
            </div>
        </main>

        <!-- Module Loading Overlay -->
        <div class="module-loading-overlay" id="moduleLoadingOverlay">
            <div class="module-loading-spinner"></div>
            <div class="module-loading-text" id="moduleLoadingText">Loading...</div>
        </div>
    </div>

    <!-- Cache module (must load first) -->
    <script src="/dashboard/shared/js/cache.js"></script>

    <script type="module">
        import { supabase } from '/dashboard/shared/js/supabase.js';
        import API from '/dashboard/shared/js/api.js';

        window.API = API;
        window.supabase = supabase;

        // App state
        const appState = {
            currentPage: null,
            loadedModules: new Set(),
            profile: null
        };

        // Security
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        document.addEventListener('dragstart', (e) => {
            if (!e.target.closest('[draggable="true"]')) e.preventDefault();
        });

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('ðŸ”’ SteadyManager Shell initializing...');
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            setupNavigation();
            setupUserMenu();
            setupMobileTitleClick();
            
            await initializeShell();
        });

        async function initializeShell() {
            try {
                if (!API) throw new Error('API failed to load');

                const { authenticated } = await API.checkAuth();
                if (!authenticated) {
                    window.location.href = '/auth/login.html';
                    return;
                }

                const { data: { session } } = await supabase.auth.getSession();
                if (!session?.user?.email_confirmed_at) {
                    window.location.href = '/auth/resend-verification.html';
                    return;
                }

                // SECURITY: Verify tier access using new API method
                const tierCheck = await API.verifyTierAccess('professional');

                if (!tierCheck.authorized) {
                    showUnauthorizedAccess(tierCheck);
                    return;
                }

                const profile = await API.getProfile();
                if (!profile?.id) throw new Error('Invalid profile');

                // Check if user was just upgraded to admin - clear cache if tier changed
                const cachedTier = localStorage.getItem('cached_user_tier');
                if (cachedTier && cachedTier !== profile.user_type) {
                    console.log(`ðŸ”„ Tier changed from ${cachedTier} to ${profile.user_type} - clearing cache`);
                    if (window.AppCache) {
                        window.AppCache.clear();
                    }
                }
                localStorage.setItem('cached_user_tier', profile.user_type);

                appState.profile = profile;
                loadUserProfile(profile);

                // Load and apply user preferences
                await loadUserPreferences();

                console.log('âœ… Shell initialized');

            } catch (error) {
                console.error('âŒ Shell init failed:', error);
                showError(API.handleAPIError(error, 'Shell'));
            }
        }

        async function buildSidebar() {
            try {
                const enabledModules = await API.getEnabledModules();

                // Module definitions with icons and labels
                const moduleDefinitions = {
                    dashboard: { icon: 'layout-dashboard', label: 'Dashboard' },
                    leads: { icon: 'user-plus', label: 'Add Leads' },
                    pipeline: { icon: 'git-branch', label: 'Pipeline' },
                    tasks: { icon: 'list-checks', label: 'Tasks' },
                    jobs: { icon: 'briefcase', label: 'Jobs' },
                    goals: { icon: 'target', label: 'Goals' },
                    estimates: { icon: 'file-text', label: 'Estimates' },
                    notes: { icon: 'sticky-note', label: 'Notes' },
                    settings: { icon: 'settings', label: 'Settings' }
                };

                // Build nav items HTML - settings always goes last
                const modulesWithoutSettings = enabledModules.filter(id => id !== 'settings');
                const navHTML = modulesWithoutSettings
                    .filter(moduleId => moduleDefinitions[moduleId]) // Only include defined modules
                    .map(moduleId => {
                        const module = moduleDefinitions[moduleId];
                        return `
                            <li class="nav-item">
                                <a href="#" class="nav-link" data-page="${moduleId}">
                                    <i data-lucide="${module.icon}" class="nav-icon"></i>
                                    <span>${module.label}</span>
                                </a>
                            </li>
                        `;
                    })
                    .join('') +
                    // Always add Settings at the end
                    `<li class="nav-item">
                        <a href="#" class="nav-link" data-page="settings">
                            <i data-lucide="settings" class="nav-icon"></i>
                            <span>Settings</span>
                        </a>
                    </li>`;

                // Update sidebar
                const sidebarNav = document.getElementById('sidebar-nav');
                if (sidebarNav) {
                    sidebarNav.innerHTML = navHTML;

                    // Re-init lucide icons
                    if (typeof lucide !== 'undefined') lucide.createIcons();

                    // Re-attach navigation listeners
                    setupNavigation();
                }

                console.log(`âœ… Sidebar built with ${enabledModules.length} modules`);

            } catch (error) {
                console.error('Failed to build sidebar:', error);
            }
        }

        // Expose global refresh function for ModuleMarket
        window.refreshSidebar = buildSidebar;

        async function loadUserPreferences() {
            try {
                // Build sidebar first
                await buildSidebar();

                const prefs = await API.getPreferences();

                // Apply theme
                const theme = prefs.theme || 'light';
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('dashboard-theme', theme);

                // Store windowing preference globally
                window.windowingEnabled = prefs.windowing_enabled || false;

                // Select default view navigation item (triggers normal navigation flow for skeleton)
                const defaultView = prefs.default_view || 'dashboard';
                const navLink = document.querySelector(`.nav-link[data-page="${defaultView}"]`);
                if (navLink) {
                    navLink.click(); // Triggers navigation system (skeleton works properly)
                } else {
                    // Fallback if nav link not found
                    await loadPage(defaultView);
                }

                console.log(`âœ… Preferences loaded - Theme: ${theme}, Default: ${defaultView}, Windowing: ${window.windowingEnabled}`);

            } catch (error) {
                console.error('Failed to load preferences:', error);
                // Fallback to defaults
                const dashboardNav = document.querySelector('.nav-link[data-page="dashboard"]');
                if (dashboardNav) {
                    dashboardNav.click();
                } else {
                    await loadPage('dashboard');
                }
            }
        }

        async function loadPage(pageName) {
            // If clicking Jobs while already on Jobs, go back to hub
            if (appState.currentPage === pageName && pageName === 'jobs') {
                console.log('Returning to Jobs hub');
                if (window.JobsModule?.state) {
                    window.JobsModule.state.activeSection = null;
                    window.JobsModule.renderSectionSelector();
                }
                return;
            }

            // Skip if already on this page
            if (appState.currentPage === pageName) {
                console.log(`Already on ${pageName}`);
                return;
            }

            console.log(`Loading: ${pageName}`);

            // Update UI
            document.querySelectorAll('.page-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`${pageName}-content`)?.classList.add('active');

            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            document.querySelector(`[data-page="${pageName}"]`)?.classList.add('active');

            const titles = {
                dashboard: 'Dashboard',
                leads: 'Add Leads',
                pipeline: 'Pipeline',
                tasks: 'Tasks',
                jobs: 'Jobs',
                goals: 'Goals',
                estimates: 'Estimates',
                notes: 'Notes',
                settings: 'Settings',
                'module-market': 'Module Market'
            };
            document.getElementById('pageTitle').textContent = titles[pageName] || 'Dashboard';

            // Update state
            appState.currentPage = pageName;

            // Load module
            await loadModule(pageName);
        }

        async function loadModule(pageName) {
            try {
                // Show loading overlay
                const overlay = document.getElementById('moduleLoadingOverlay');
                const loadingText = document.getElementById('moduleLoadingText');

                const moduleNames = {
                    'dashboard': 'Dashboard',
                    'leads': 'Leads',
                    'pipeline': 'Pipeline',
                    'tasks': 'Tasks',
                    'jobs': 'Jobs Hub',
                    'goals': 'Goals',
                    'estimates': 'Estimates',
                    'notes': 'Notes',
                    'settings': 'Settings',
                    'module-market': 'Module Market'
                };

                if (loadingText) {
                    loadingText.textContent = `Loading ${moduleNames[pageName] || 'Module'}...`;
                }
                if (overlay) {
                    overlay.classList.add('active');
                }

                const modules = {
                    dashboard: window.DashboardModule,
                    leads: window.AddLeadModule,
                    pipeline: window.PipelineModule,
                    tasks: window.SchedulingModule,
                    jobs: window.JobsModule,
                    goals: window.GoalsModule,
                    estimates: window.EstimatesModule,
                    notes: window.NotesModule,
                    settings: window.SettingsModule,
                    'module-market': window.ModuleMarketModule
                };

                const module = modules[pageName];
                if (!module?.init) {
                    console.log(`âš ï¸ Module ${pageName} not loaded yet`);
                    if (overlay) overlay.classList.remove('active');
                    return;
                }

                // Always reload to get fresh data
                await module.init(`${pageName}-content`);

                // Hide loading overlay
                if (overlay) {
                    overlay.classList.remove('active');
                }

                appState.loadedModules.add(pageName);
                console.log(`ðŸ“¦ ${pageName} loaded`);
                
            } catch (error) {
                console.error(`Module load error:`, error);
            }
        }

        function loadUserProfile(profile) {
            const email = profile.email || 'User';
            const initials = generateInitials(email);
            
            const tierNames = {
                'free': 'Free Plan',
                'professional': 'Professional',
                'professional_trial': 'Pro Trial',
                'business': 'Business',
                'enterprise': 'Enterprise',
                'admin': 'Admin'
            };
            
            document.getElementById('userName').textContent = email;
            document.getElementById('userTier').textContent = tierNames[profile.user_type] || 'Professional';
            
            const avatar = document.getElementById('userAvatar');
            avatar.innerHTML = '';
            avatar.textContent = initials;
        }

        function generateInitials(email) {
            if (!email) return 'U';
            const name = email.split('@')[0];
            const parts = name.split(/[._-]/);
            if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
            return name.substring(0, 2).toUpperCase();
        }

        function setupNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.getAttribute('data-page');
                    
                    if (window.innerWidth <= 1024) {
                        setTimeout(() => {
                            document.getElementById('sidebar')?.classList.remove('mobile-open');
                        }, 150);
                    }
                    
                    if (page) loadPage(page);
                });
            });
        }

        function setupUserMenu() {
            const menu = document.getElementById('userMenu');
            
            // Click profile pic = go to Settings
            menu.onclick = () => {
                loadPage('settings');
            };
        }

        function setupMobileTitleClick() {
            const title = document.getElementById('pageTitle');
            const sidebar = document.getElementById('sidebar');
            const main = document.querySelector('.main-content');
            
            title.onclick = () => {
                if (window.innerWidth <= 1024) {
                    sidebar.classList.toggle('mobile-open');
                } else {
                    sidebar.classList.toggle('desktop-hidden');
                    main.classList.toggle('sidebar-hidden');
                }
            };
            
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 1024 && 
                    !sidebar.contains(e.target) && 
                    !title.contains(e.target)) {
                    sidebar.classList.remove('mobile-open');
                }
            });
        }

        function showError(msg) {
            const container = document.getElementById('dashboard-content');
            if (!container) return;

            container.innerHTML = `
                <div style="text-align: center; padding: 4rem;">
                    <h2>Connection Error</h2>
                    <p style="margin: 1rem 0;">${API.escapeHtml(msg)}</p>
                    <button onclick="location.reload()" style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-weight: 600;">Retry</button>
                </div>
            `;
        }

        function showUnauthorizedAccess(tierCheck) {
            document.body.innerHTML = `
                <div style="
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    min-height: 100vh;
                    background: var(--gradient-primary);
                    font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                ">
                    <div style="
                        background: var(--surface);
                        padding: 3rem;
                        border-radius: 20px;
                        box-shadow: var(--shadow-modal);
                        text-align: center;
                        max-width: 500px;
                        animation: slideUp 0.4s ease;
                    ">
                        <div style="
                            font-size: 4rem;
                            margin-bottom: 1rem;
                        ">ðŸš«</div>
                        <h1 style="
                            font-size: 2rem;
                            font-weight: 900;
                            color: var(--text-primary);
                            margin-bottom: 1rem;
                        ">Wrong Tier!</h1>
                        <p style="
                            color: var(--text-secondary);
                            font-size: 1.125rem;
                            margin-bottom: 0.5rem;
                            line-height: 1.6;
                        ">You're trying to access <strong>Professional</strong> features</p>
                        <p style="
                            color: var(--text-secondary);
                            font-size: 1rem;
                            margin-bottom: 2rem;
                        ">Your current tier: <strong style="color: var(--danger);">${API.escapeHtml(tierCheck.userTier.toUpperCase())}</strong></p>
                        <div style="display: flex; gap: 1rem; justify-content: center;">
                            <button onclick="window.location.href='/dashboard/'" style="
                                padding: 0.875rem 2rem;
                                background: var(--gradient-primary);
                                color: white;
                                border: none;
                                border-radius: 12px;
                                cursor: pointer;
                                font-weight: 700;
                                font-size: 1rem;
                                transition: all 0.3s ease;
                                box-shadow: var(--job-btn-shadow-hover);
                            " onmouseover="this.style.transform='translateY(-2px)';" onmouseout="this.style.transform='translateY(0)';">
                                Go Back to Dashboard
                            </button>
                        </div>
                    </div>
                </div>
                <style>
                    @keyframes slideUp {
                        from {
                            opacity: 0;
                            transform: translateY(30px);
                        }
                        to {
                            opacity: 1;
                            transform: translateY(0);
                        }
                    }
                </style>
            `;
        }

        window.loadPage = loadPage;
    </script>

    <script src="/dashboard/shared/js/utils.js"></script>
    <script src="/dashboard/scripts/Dashboard.js"></script>
    <script src="/dashboard/scripts/Leads.js"></script>
    <script src="/dashboard/scripts/Pipeline.js"></script>
    <script src="/dashboard/scripts/Scheduling.js"></script>
    <script src="/dashboard/scripts/Jobs.js"></script>
    <script src="/dashboard/scripts/JobsManagement.js"></script>
    <script src="/dashboard/scripts/Clients.js"></script>
    <script src="/dashboard/scripts/Goals.js"></script>
    <script src="/dashboard/scripts/Estimates.js"></script>
    <script src="/dashboard/scripts/Notes.js"></script>
    <script src="/dashboard/scripts/Settings.js"></script>
    <script src="/dashboard/scripts/ModuleMarket.js"></script>
</body>
</html>