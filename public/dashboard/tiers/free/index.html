<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SteadyManager - Free Dashboard</title>
    
    <!-- External Dependencies -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- üîê AUTH MANAGER (matches your server auth system) -->
    <script src="/dashboard/shared/js/auth.js"></script>
</head>
<>
    <!-- Loading Screen (minimal - your scripts will replace this) -->
    <div id="loading" class="fixed inset-0 bg-white flex items-center justify-center z-50">
        <div class="text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
            <p class="text-gray-600">Loading your dashboard...</p>
        </div>
    </div>

    <!-- React App Container (minimal - your scripts handle the UI) -->
    <div id="app" class="hidden"></div>

    <!-- üîí SECURE AUTHENTICATION SETUP -->
    <script>
        // üî• AUTHENTICATION INITIALIZATION
        let currentUser = null;
        let isAuthenticated = false;

        // üîê Initialize authentication on page load
        async function initAuth() {
            try {
                console.log('üîç Checking authentication...');
                
                // Use the AuthManager from your auth.js
                const authResult = await window.authManager.checkAuth();
                
                if (!authResult) {
                    console.error('‚ùå Authentication failed');
                    window.location.href = '/login?error=session_expired';
                    return false;
                }
                
                currentUser = window.authManager.user;
                isAuthenticated = true;
                
                console.log('‚úÖ User authenticated:', currentUser.email, `(${currentUser.subscriptionTier})`);
                
                // üõ°Ô∏è TIER VERIFICATION - Make sure user belongs here
                if (currentUser.subscriptionTier !== 'FREE') {
                    console.warn('‚ö†Ô∏è User has different tier, redirecting to appropriate dashboard');
                    window.location.href = '/dashboard'; // Server will route to correct tier
                    return false;
                }
                
                return true;
                
            } catch (error) {
                console.error('üö´ Auth initialization failed:', error);
                window.location.href = '/login?error=auth_failed';
                return false;
            }
        }

        // üåê SECURE API CALLS (uses your cookie-based auth)
        window.authenticatedFetch = async (url, options = {}) => {
            if (!isAuthenticated) {
                console.error('‚ùå Not authenticated for API call');
                window.location.href = '/login?error=session_expired';
                return;
            }
            
            try {
                // Use AuthManager's secure API request method
                const response = await window.authManager.apiRequest(url, options);
                return response;
            } catch (error) {
                console.error('üö´ API request failed:', error);
                throw error;
            }
        };

        // üéØ USER DATA HELPERS
        window.getUserData = () => currentUser;
        
        window.getLeadLimitInfo = () => {
            if (!currentUser) return null;
            return window.authManager.getLeadLimitInfo();
        };

        // üîì LOGOUT FUNCTION
        window.logout = async () => {
            await window.authManager.logout();
        };
    </script>

    <!-- üéØ FREE TIER SCRIPTS (from /dashboard/tiers/free/scripts/) -->
    <script src="scripts/utils.js"></script>
    <script src="scripts/api.js"></script>

    <!-- üîí TIER CONFIGURATION -->
    <script>
        // üéØ FREE TIER PERMISSIONS
        window.TIER = 'FREE';
        window.TIER_LIMITS = {
            leadLimit: 50,
            features: ['basic_dashboard', 'add_leads', 'basic_settings', 'lead_management'],
            locked: ['analytics', 'insights', 'schedule', 'pipeline', 'activity', 'ai_scoring', 'automation'],
            upgradeMessage: 'Upgrade to Professional to unlock this feature!'
        };

        // üöÄ INITIALIZE DASHBOARD
        async function initDashboard() {
            // 1. Check authentication first
            const authSuccess = await initAuth();
            if (!authSuccess) return;
            
            // 2. Hide loading screen
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // 3. Load dashboard components
            console.log('üéØ Loading FREE tier dashboard components...');
            
            // Load components in order
            const scriptsToLoad = [
                'scripts/dashboard.js',
                'scripts/AddLead.js', 
                'scripts/Settings.js'
            ];
            
            for (const script of scriptsToLoad) {
                await loadScript(script);
            }
            
            // 4. Initialize React app
            initReactApp();
        }

        // üìú DYNAMIC SCRIPT LOADER
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.type = 'text/babel';
                script.src = src;
                script.onload = () => {
                    console.log(`‚úÖ Loaded: ${src}`);
                    resolve();
                };
                script.onerror = () => {
                    console.error(`‚ùå Failed to load: ${src}`);
                    reject(new Error(`Failed to load ${src}`));
                };
                document.head.appendChild(script);
            });
        }

        // ‚öõÔ∏è INITIALIZE REACT APP
        function initReactApp() {
            try {
                console.log('‚öõÔ∏è Initializing React dashboard...');
                
                // Make sure Dashboard component is loaded
                if (typeof Dashboard === 'undefined') {
                    console.error('‚ùå Dashboard component not found');
                    document.getElementById('app').innerHTML = `
                        <div class="min-h-screen flex items-center justify-center">
                            <div class="text-center">
                                <h1 class="text-2xl font-bold text-red-600 mb-4">Dashboard Loading Error</h1>
                                <p class="text-gray-600 mb-4">Failed to load dashboard components.</p>
                                <button onclick="window.location.reload()" 
                                        class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                    Reload Page
                                </button>
                            </div>
                        </div>
                    `;
                    return;
                }
                
                // Render the dashboard
                ReactDOM.render(React.createElement(Dashboard), document.getElementById('app'));
                console.log('üöÄ FREE tier dashboard loaded successfully!');
                
            } catch (error) {
                console.error('‚ùå React initialization failed:', error);
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen flex items-center justify-center">
                        <div class="text-center">
                            <h1 class="text-2xl font-bold text-red-600 mb-4">Dashboard Error</h1>
                            <p class="text-gray-600 mb-4">Something went wrong loading your dashboard.</p>
                            <button onclick="window.location.reload()" 
                                    class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                                Try Again
                            </button>
                        </div>
                    </div>
                `;
            }
        }

        // üöÄ START THE APP when DOM is ready
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>

    <!-- üîí LOCKED FEATURES NOTICE (Not loaded for free tier) -->
    <!-- 
    PROFESSIONAL+ ONLY FEATURES:
    - Analytics Dashboard (scripts/Analytics.js)
    - Advanced Insights (scripts/Insights.js) 
    - Schedule Management (scripts/Schedule.js)
    
    BUSINESS+ ONLY FEATURES:
    - Pipeline Management (scripts/Pipeline.js)
    - Activity Tracking (scripts/Activity.js)
    - AI Lead Scoring
    - Automation Tools
    
    ENTERPRISE+ ONLY FEATURES:
    - White-label options
    - Custom integrations
    - Advanced reporting
    -->


</body>
</html>