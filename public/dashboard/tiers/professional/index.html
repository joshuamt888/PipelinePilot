<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        (function() {
            const savedTheme = localStorage.getItem('dashboard-theme');
            if (savedTheme) {
                document.documentElement.setAttribute('data-theme', savedTheme);
            }
        })();
    </script>
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' https://unpkg.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; connect-src 'self' https://*.supabase.co; font-src 'self' data:;">
    <title>SteadyManager - Dashboard</title>
    
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #4f46e5;
            --primary-light: #dbeafe;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --info: #06b6d4;
            
            --background: #f8fafc;
            --surface: #ffffff;
            --surface-hover: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-tertiary: #64748b;
            --border: #e2e8f0;
            
            --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 20px 25px -5px rgb(0 0 0 / 0.1);
            --shadow-xl: 0 25px 50px -12px rgb(0 0 0 / 0.25);
            
            --radius: 8px;
            --radius-lg: 16px;
            --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        [data-theme="dark"] {
            --background: #0a0f1c;
            --surface: #1a1f2e;
            --surface-hover: #242938;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --text-tertiary: #94a3b8;
            --border: #374151;
            --primary: #6366f1;
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            -webkit-user-select: none;
            -moz-user-select: none;
            user-select: none;
        }

        input, textarea, [contenteditable] {
            -webkit-user-select: text;
            -moz-user-select: text;
            user-select: text;
        }

        html, body {
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--background);
            color: var(--text-primary);
            line-height: 1.6;
            transition: var(--transition);
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            bottom: 0;
            width: 280px;
            background: var(--gradient-primary);
            color: white;
            z-index: 1000;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }

        .sidebar-content {
            padding: 2rem 0;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 0 1.5rem 2rem;
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            margin-bottom: 2rem;
        }

        .sidebar-logo {
            font-size: 1.75rem;
            font-weight: 900;
            text-align: center;
            color: white;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .sidebar-nav {
            list-style: none;
            padding: 0;
            margin-bottom: auto;
            flex: 1;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem 1.5rem;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            transition: var(--transition);
            font-weight: 500;
            cursor: pointer;
            margin: 0 0.75rem;
            border-radius: var(--radius);
        }

        .nav-link:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            transform: translateX(8px);
        }

        .nav-link.active {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            font-weight: 600;
            transform: translateX(8px);
        }

        .nav-emoji {
            font-size: 1.2rem;
        }

        .upgrade-nav-item {
            margin: 1.5rem 0.75rem 1rem;
        }

        .upgrade-nav-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--radius-lg);
            color: white;
            text-decoration: none;
            font-weight: 700;
            font-size: 0.95rem;
            transition: var(--transition);
            cursor: pointer;
        }

        .upgrade-nav-link:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .main-content {
            margin-left: 280px;
            height: 100vh;
            background: var(--background);
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .page-content {
            display: none;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .page-content.active {
            display: block;
            opacity: 1;
        }

        .header {
            background: var(--surface);
            padding: 1.25rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border);
            height: 80px;
            flex-shrink: 0;
            z-index: 100;
        }

        .header-title {
    font-size: 1.5rem;
    font-weight: 800;
    color: var(--text-primary);
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    cursor: pointer;
    padding: 0.5rem 1.5rem 0.5rem 1rem;
    border-radius: var(--radius-lg);
    transition: var(--transition);
    border: 2px solid transparent;
    position: relative;
    display: inline-block;
}

.header-title::before {
    content: '⛶';
    position: absolute;
    right: 8px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1rem;
    opacity: 0;
    transition: all 0.3s ease;
    background: var(--gradient-primary);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}

.header-title:hover {
    border: 2px solid var(--primary);
    box-shadow: 0 0 20px rgba(102, 126, 234, 0.6);
    transform: scale(1.05);
    padding-right: 2.5rem;
}

.header-title:hover::before {
    opacity: 1;
}

.header-title:active {
    transform: scale(0.98);
}

        .user-menu-container {
            position: relative;
            z-index: 999999;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            background: var(--surface-hover);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-lg);
            cursor: pointer;
            transition: var(--transition);
            border: 1px solid var(--border);
        }

        .user-menu:hover {
            border-color: var(--primary);
            transform: translateY(-1px);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: var(--radius);
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
            font-size: 0.9rem;
        }

        .user-info {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-primary);
        }

        .user-tier {
            font-size: 0.75rem;
            color: var(--success);
            font-weight: 500;
        }

        .profile-dropdown {
            position: fixed !important;
            top: 80px !important;
            right: 2rem !important;
            width: 220px !important;
            background: var(--surface) !important;
            border: 1px solid var(--border) !important;
            border-radius: var(--radius-lg) !important;
            box-shadow: var(--shadow-xl) !important;
            overflow: hidden !important;
            z-index: 2147483647 !important;
            opacity: 0 !important;
            visibility: hidden !important;
            transform: translateY(-10px) !important;
            transition: all 0.3s ease !important;
        }

        .profile-dropdown.show {
            opacity: 1 !important;
            visibility: visible !important;
            transform: translateY(0) !important;
        }

        .dropdown-item {
            display: flex !important;
            align-items: center !important;
            gap: 0.75rem !important;
            padding: 1rem !important;
            color: var(--text-primary) !important;
            cursor: pointer !important;
            transition: var(--transition) !important;
            font-size: 0.875rem !important;
        }

        .dropdown-item:hover {
            background: var(--surface-hover) !important;
        }

        .logout-item {
            color: var(--danger) !important;
            border-top: 1px solid var(--border) !important;
        }

        .toggle-switch {
            position: relative !important;
            width: 40px !important;
            height: 20px !important;
            background: var(--border) !important;
            border-radius: 9999px !important;
            margin-left: auto !important;
        }

        .toggle-slider {
            position: absolute !important;
            top: 2px !important;
            left: 2px !important;
            width: 16px !important;
            height: 16px !important;
            background: white !important;
            border-radius: 50% !important;
            transition: var(--transition) !important;
        }

        [data-theme="dark"] .toggle-switch {
            background: var(--primary) !important;
        }

        [data-theme="dark"] .toggle-slider {
            transform: translateX(20px) !important;
        }

        .dashboard-content {
            flex: 1;
            overflow-y: auto;
            padding: 2rem;
            background: var(--background);
        }

        .content-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .sidebar.desktop-hidden {
            transform: translateX(-100%);
        }
        
        .main-content.sidebar-hidden {
            margin-left: 0;
        }

        @media (max-width: 1024px) {
            .sidebar {
                transform: translateX(-100%);
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
            }
        }

        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid rgba(102, 126, 234, 0.3);
            border-radius: 50%;
            border-top-color: var(--primary);
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        [data-theme="dark"] .sidebar {
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 50%, #1e293b 100%);
        }
    </style>
</head>
<body data-theme="light">
    <div class="sidebar" id="sidebar">
        <div class="sidebar-content">
            <div class="sidebar-header">
                <div class="sidebar-logo">SteadyManager</div>
            </div>

            <nav>
                <ul class="sidebar-nav">
                    <li class="nav-item">
                        <a href="#" class="nav-link active" data-page="dashboard">
                            <span class="nav-emoji">📊</span>
                            <span>Dashboard</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="leads">
                            <span class="nav-emoji">👥</span>
                            <span>Add Leads</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="pipeline">
                            <span class="nav-emoji">🌿</span>
                            <span>Pipeline</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="tasks">
                            <span class="nav-emoji">📋</span>
                            <span>Tasks</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#" class="nav-link" data-page="settings">
                            <span class="nav-emoji">⚙️</span>
                            <span>Settings</span>
                        </a>
                    </li>
                </ul>
            </nav>

            <div class="upgrade-nav-item">
                <a href="#" class="upgrade-nav-link" data-page="upgrade">
                    <span>🚀 Upgrade Plan</span>
                </a>
            </div>
        </div>
    </div>

    <div class="main-content">
        <header class="header">
            <h1 class="header-title" id="pageTitle">Dashboard</h1>
            
            <div class="user-menu-container">
                <div class="user-menu" id="userMenu">
                    <div class="user-avatar" id="userAvatar">
                        <div class="loading-spinner"></div>
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Loading...</div>
                        <div class="user-tier" id="userTier">Free Plan</div>
                    </div>
                </div>
                
                <div class="profile-dropdown" id="profileDropdown">
                    <div class="dropdown-item" id="darkModeToggle">
                        <span>🌙 Dark Mode</span>
                        <div class="toggle-switch">
                            <div class="toggle-slider"></div>
                        </div>
                    </div>
                    <div class="dropdown-item" data-page="settings">
                        <span>⚙️ Settings</span>
                    </div>
                    <div class="dropdown-item logout-item" id="logoutBtn">
                        <span>🚪 Logout</span>
                    </div>
                </div>
            </div>
        </header>

        <main class="dashboard-content">
            <div class="content-container">
                <div id="dashboard-content" class="page-content active"></div>
                <div id="leads-content" class="page-content"></div>
                <div id="pipeline-content" class="page-content"></div>
                <div id="tasks-content" class="page-content"></div>
                <div id="settings-content" class="page-content"></div>
                <div id="upgrade-content" class="page-content"></div>
            </div>
        </main>

        <!-- Quick Action Button (Pro Tier) -->
        <div class="quick-actions-fab" id="quickActionsFab">
            <button class="fab-main" id="fabMain">+</button>
            <div class="fab-menu" id="fabMenu">
                <button class="fab-item" onclick="OverlayManager.open('quick-add-lead')">
                    <span class="fab-icon">👤</span>
                    <span class="fab-label">Add Lead</span>
                </button>
                <button class="fab-item" onclick="OverlayManager.open('quick-add-job')">
                    <span class="fab-icon">💼</span>
                    <span class="fab-label">Add Job</span>
                </button>
            </div>
        </div>

        <style>
            .quick-actions-fab {
                position: fixed;
                bottom: 2rem;
                right: 2rem;
                z-index: 1500;
            }

            .fab-main {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                background: var(--gradient-primary);
                border: none;
                color: white;
                font-size: 2rem;
                font-weight: 300;
                cursor: pointer;
                box-shadow: 0 8px 16px rgba(102, 126, 234, 0.3);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                display: flex;
                align-items: center;
                justify-content: center;
                line-height: 1;
            }

            .fab-main:hover {
                transform: scale(1.1) rotate(90deg);
                box-shadow: 0 12px 24px rgba(102, 126, 234, 0.4);
            }

            .fab-main.active {
                transform: rotate(45deg);
            }

            .fab-menu {
                position: absolute;
                bottom: 80px;
                right: 0;
                display: flex;
                flex-direction: column-reverse;
                gap: 0.75rem;
                opacity: 0;
                visibility: hidden;
                transform: scale(0.8);
                transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            }

            .fab-menu.active {
                opacity: 1;
                visibility: visible;
                transform: scale(1);
            }

            .fab-item {
                display: flex;
                align-items: center;
                gap: 0.75rem;
                padding: 0.75rem 1.25rem;
                background: var(--surface);
                border: 1px solid var(--border);
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-lg);
                cursor: pointer;
                transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
                white-space: nowrap;
            }

            .fab-item:hover {
                background: var(--surface-hover);
                transform: translateX(-4px);
                box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
            }

            .fab-icon {
                font-size: 1.25rem;
            }

            .fab-label {
                font-weight: 600;
                color: var(--text-primary);
                font-size: 0.875rem;
            }

            @media (max-width: 768px) {
                .quick-actions-fab {
                    bottom: 1rem;
                    right: 1rem;
                }

                .fab-main {
                    width: 50px;
                    height: 50px;
                    font-size: 1.75rem;
                }

                .fab-menu {
                    bottom: 70px;
                }

                .fab-label {
                    display: none;
                }
            }
        </style>

        <script>
            // Quick Actions FAB Toggle
            document.addEventListener('DOMContentLoaded', () => {
                const fabMain = document.getElementById('fabMain');
                const fabMenu = document.getElementById('fabMenu');

                if (fabMain && fabMenu) {
                    fabMain.onclick = () => {
                        fabMain.classList.toggle('active');
                        fabMenu.classList.toggle('active');
                    };

                    // Close menu when clicking outside
                    document.addEventListener('click', (e) => {
                        if (!e.target.closest('.quick-actions-fab')) {
                            fabMain.classList.remove('active');
                            fabMenu.classList.remove('active');
                        }
                    });
                }
            });
        </script>
    </div>

    <script type="module">
        import { supabase } from '/dashboard/shared/js/supabase.js';
        import API from '/dashboard/shared/js/api.js';

        window.API = API;
        window.supabase = supabase;

        // App state
        const appState = {
            currentPage: null,
            loadedModules: new Set(),
            profile: null
        };

        // Security
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        document.addEventListener('dragstart', (e) => {
            if (!e.target.closest('[draggable="true"]')) e.preventDefault();
        });

        // Initialize on DOM ready
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('🔒 SteadyManager Shell initializing...');
            
            if (typeof lucide !== 'undefined') lucide.createIcons();
            
            setupNavigation();
            setupUserMenu();
            setupMobileTitleClick();
            
            await initializeShell();
        });

        async function initializeShell() {
            try {
                if (!API) throw new Error('API failed to load');
                
                const { authenticated } = await API.checkAuth();
                if (!authenticated) {
                    window.location.href = '/auth/login.html';
                    return;
                }
                
                const { data: { session } } = await supabase.auth.getSession();
                if (!session?.user?.email_confirmed_at) {
                    window.location.href = '/auth/resend-verification.html';
                    return;
                }

                const profile = await API.getProfile();
                if (!profile?.id) throw new Error('Invalid profile');
                
                appState.profile = profile;
                loadUserProfile(profile);
                
                console.log('✅ Shell initialized');
                await loadPage('dashboard');
                
            } catch (error) {
                console.error('❌ Shell init failed:', error);
                showError(API.handleAPIError(error, 'Shell'));
            }
        }

        async function loadPage(pageName) {
            // Skip if already on this page
            if (appState.currentPage === pageName) {
                console.log(`Already on ${pageName}`);
                return;
            }
            
            console.log(`Loading: ${pageName}`);
            
            // Update UI
            document.querySelectorAll('.page-content').forEach(c => c.classList.remove('active'));
            document.getElementById(`${pageName}-content`)?.classList.add('active');
            
            document.querySelectorAll('.nav-link, .upgrade-nav-link').forEach(l => l.classList.remove('active'));
            if (pageName === 'upgrade') {
                document.querySelector('.upgrade-nav-link')?.classList.add('active');
            } else {
                document.querySelector(`[data-page="${pageName}"]`)?.classList.add('active');
            }
            
            const titles = {
                dashboard: 'Dashboard',
                leads: 'Add Leads',
                pipeline: 'Pipeline',
                tasks: 'Tasks',
                settings: 'Settings',
                upgrade: 'Upgrade Plan'
            };
            document.getElementById('pageTitle').textContent = titles[pageName] || 'Dashboard';
            
            // Update state
            appState.currentPage = pageName;
            
            // Load module
            await loadModule(pageName);
        }

        async function loadModule(pageName) {
            try {
                const modules = {
                    dashboard: window.DashboardModule,
                    leads: window.AddLeadModule,
                    pipeline: window.PipelineModule,
                    tasks: window.SchedulingModule,
                    settings: window.SettingsModule
                };
                
                const module = modules[pageName];
                if (!module?.init) return;
                
                // Always reload to get fresh data
                await module.init(`${pageName}-content`);
                appState.loadedModules.add(pageName);
                console.log(`📦 ${pageName} loaded`);
                
            } catch (error) {
                console.error(`Module load error:`, error);
            }
        }

        function loadUserProfile(profile) {
            const email = profile.email || 'User';
            const initials = generateInitials(email);
            
            const tierNames = {
                'free': 'Free Plan',
                'professional': 'Professional',
                'professional_trial': 'Trial',
                'business': 'Business',
                'enterprise': 'Enterprise',
                'admin': 'Admin'
            };
            
            document.getElementById('userName').textContent = email;
            document.getElementById('userTier').textContent = tierNames[profile.user_type] || 'Free Plan';
            
            const avatar = document.getElementById('userAvatar');
            avatar.innerHTML = '';
            avatar.textContent = initials;
        }

        function generateInitials(email) {
            if (!email) return 'U';
            const name = email.split('@')[0];
            const parts = name.split(/[._-]/);
            if (parts.length >= 2) return (parts[0][0] + parts[1][0]).toUpperCase();
            return name.substring(0, 2).toUpperCase();
        }

        function toggleTheme() {
            const current = document.documentElement.getAttribute('data-theme');
            const newTheme = current === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('dashboard-theme', newTheme);
            if (window.SteadyUtils?.showToast) {
                SteadyUtils.showToast(`Switched to ${newTheme} mode`, 'success');
            }
        }

        function setupNavigation() {
            document.querySelectorAll('.nav-link, .upgrade-nav-link').forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const page = link.getAttribute('data-page');
                    
                    if (window.innerWidth <= 1024) {
                        setTimeout(() => {
                            document.getElementById('sidebar')?.classList.remove('mobile-open');
                        }, 150);
                    }
                    
                    if (page) loadPage(page);
                });
            });
        }

        function setupUserMenu() {
            const menu = document.getElementById('userMenu');
            const dropdown = document.getElementById('profileDropdown');
            
            menu.onclick = (e) => {
                e.stopPropagation();
                dropdown.classList.toggle('show');
            };
            
            document.addEventListener('click', () => dropdown.classList.remove('show'));
            
            document.getElementById('darkModeToggle').onclick = (e) => {
                e.stopPropagation();
                toggleTheme();
            };
            
            dropdown.querySelector('[data-page="settings"]').addEventListener('click', () => {
                loadPage('settings');
                dropdown.classList.remove('show');
            });
            
            document.getElementById('logoutBtn').onclick = async () => {
                if (!confirm('Logout?')) return;
                try {
                    await API.logout();
                } catch (e) {
                    console.error('Logout error:', e);
                }
                window.location.href = '/auth/login.html';
            };
        }

        function setupMobileTitleClick() {
            const title = document.getElementById('pageTitle');
            const sidebar = document.getElementById('sidebar');
            const main = document.querySelector('.main-content');
            
            title.onclick = () => {
                if (window.innerWidth <= 1024) {
                    sidebar.classList.toggle('mobile-open');
                } else {
                    sidebar.classList.toggle('desktop-hidden');
                    main.classList.toggle('sidebar-hidden');
                }
            };
            
            document.addEventListener('click', (e) => {
                if (window.innerWidth <= 1024 && 
                    !sidebar.contains(e.target) && 
                    !title.contains(e.target)) {
                    sidebar.classList.remove('mobile-open');
                }
            });
        }

        function showError(msg) {
            const container = document.getElementById('dashboard-content');
            if (!container) return;
            
            container.innerHTML = `
                <div style="text-align: center; padding: 4rem;">
                    <h2>Connection Error</h2>
                    <p style="margin: 1rem 0;">${API.escapeHtml(msg)}</p>
                    <button onclick="location.reload()" style="padding: 0.75rem 1.5rem; background: var(--primary); color: white; border: none; border-radius: var(--radius); cursor: pointer; font-weight: 600;">Retry</button>
                </div>
            `;
        }

        window.loadPage = loadPage;
    </script>

    <!-- Core Utilities -->
    <script src="/dashboard/shared/js/utils.js"></script>

    <!-- Overlay System (Revolutionary Multi-Tasking UI) - INLINE -->
    <!-- Overlay System (Revolutionary Multi-Tasking UI) - INLINE -->
    <script>
// ==================================================================
// OVERLAY SYSTEM - ALL CODE CONSOLIDATED INTO INDEX.HTML  
// This eliminates file loading issues and ensures everything works
// ==================================================================

/**
 * OVERLAY MANAGER v1.0
 * Revolutionary multi-tasking UI for SteadyManager Pro
 *
 * Manages floating overlays (popups, modals, panels)
 * Heavily integrated with SteadyUtils for animations, theming, and utilities
 *
 * Usage:
 *   OverlayManager.open('lead-detail', { leadId: '123' });
 *   OverlayManager.open('quick-add-job');
 *   OverlayManager.close(overlayId);
 *   OverlayManager.closeAll();
 */

class OverlayManagerClass {
    constructor() {
        this.overlays = new Map();
        this.zIndexCounter = 2000; // Start above dashboard (1000)
        this.overlayTypes = {}; // Will be populated by overlay components
        this.setupGlobalStyles();
        console.log('OverlayManager v1.0 loaded 🪟');
    }

    /**
     * Register an overlay type
     * Called by overlay components to make themselves available
     */
    register(typeName, OverlayClass) {
        this.overlayTypes[typeName] = OverlayClass;
    }

    /**
     * Open an overlay
     * @param {string} type - Overlay type ('lead-detail', 'job-detail', etc)
     * @param {object} data - Data to pass to overlay
     * @returns {string} overlayId
     */
    open(type, data = {}) {
        const OverlayClass = this.overlayTypes[type];

        if (!OverlayClass) {
            console.error(`Overlay type "${type}" not registered`);
            SteadyUtils.showToast(`Cannot open ${type} overlay`, 'error');
            return null;
        }

        // Generate unique ID using utils
        const overlayId = SteadyUtils.generateId();

        // Create overlay instance
        const overlay = new OverlayClass(overlayId, data, this.zIndexCounter++);

        // Store overlay
        this.overlays.set(overlayId, overlay);

        // Render overlay
        overlay.render();

        // Lock scroll and blur background (using utils)
        SteadyUtils.lockScroll();
        SteadyUtils.blurBackground();

        // ESC to close (using utils)
        overlay.escHandler = SteadyUtils.closeOnEscape(() => {
            this.close(overlayId);
        });

        return overlayId;
    }

    /**
     * Close specific overlay
     */
    close(overlayId) {
        const overlay = this.overlays.get(overlayId);

        if (!overlay) return;

        // Call overlay's destroy method
        overlay.destroy();

        // Remove from map
        this.overlays.delete(overlayId);

        // If no more overlays, unlock scroll and unblur
        if (this.overlays.size === 0) {
            SteadyUtils.unlockScroll();
            SteadyUtils.unblurBackground();
        }
    }

    /**
     * Close all overlays
     */
    closeAll() {
        const overlayIds = Array.from(this.overlays.keys());
        overlayIds.forEach(id => this.close(id));
    }

    /**
     * Close topmost overlay
     */
    closeTop() {
        if (this.overlays.size === 0) return;

        // Find overlay with highest z-index
        let topOverlay = null;
        let maxZIndex = -1;

        this.overlays.forEach((overlay, id) => {
            if (overlay.zIndex > maxZIndex) {
                maxZIndex = overlay.zIndex;
                topOverlay = id;
            }
        });

        if (topOverlay) this.close(topOverlay);
    }

    /**
     * Check if any overlays are open
     */
    hasOpenOverlays() {
        return this.overlays.size > 0;
    }

    /**
     * Get count of open overlays
     */
    getCount() {
        return this.overlays.size;
    }

    /**
     * Setup global overlay styles
     */
    setupGlobalStyles() {
        const style = document.createElement('style');
        style.textContent = `
            /* Overlay Backdrop */
            .overlay-backdrop {
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(8px);
                -webkit-backdrop-filter: blur(8px);
                display: flex;
                align-items: center;
                justify-content: center;
                opacity: 0;
                transition: opacity 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                padding: 2rem;
            }

            .overlay-backdrop.overlay-visible {
                opacity: 1;
            }

            /* Overlay Container */
            .overlay-container {
                background: var(--surface);
                border-radius: var(--radius-lg);
                box-shadow: var(--shadow-xl);
                max-width: 90vw;
                max-height: 90vh;
                width: 100%;
                display: flex;
                flex-direction: column;
                transform: scale(0.95) translateY(20px);
                transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
                border: 1px solid var(--border);
            }

            .overlay-visible .overlay-container {
                transform: scale(1) translateY(0);
            }

            /* Overlay Header */
            .overlay-header {
                padding: 1.5rem 2rem;
                border-bottom: 1px solid var(--border);
                display: flex;
                align-items: center;
                justify-content: space-between;
                flex-shrink: 0;
            }

            .overlay-title {
                font-size: 1.25rem;
                font-weight: 700;
                color: var(--text-primary);
                margin: 0;
            }

            .overlay-close {
                width: 32px;
                height: 32px;
                border-radius: var(--radius);
                border: none;
                background: transparent;
                color: var(--text-tertiary);
                font-size: 1.5rem;
                cursor: pointer;
                display: flex;
                align-items: center;
                justify-content: center;
                transition: var(--transition);
                line-height: 1;
            }

            .overlay-close:hover {
                background: var(--surface-hover);
                color: var(--text-primary);
            }

            /* Overlay Body */
            .overlay-body {
                padding: 2rem;
                overflow-y: auto;
                flex: 1;
            }

            /* Overlay Footer */
            .overlay-footer {
                padding: 1.5rem 2rem;
                border-top: 1px solid var(--border);
                display: flex;
                align-items: center;
                justify-content: flex-end;
                gap: 0.75rem;
                flex-shrink: 0;
            }

            /* Size Variants */
            .overlay-sm .overlay-container { max-width: 400px; }
            .overlay-md .overlay-container { max-width: 600px; }
            .overlay-lg .overlay-container { max-width: 800px; }
            .overlay-xl .overlay-container { max-width: 1000px; }
            .overlay-full .overlay-container { max-width: 95vw; }

            /* Mobile Responsive */
            @media (max-width: 768px) {
                .overlay-backdrop {
                    padding: 1rem;
                }

                .overlay-container {
                    max-width: 100vw;
                    max-height: 100vh;
                    border-radius: 0;
                }

                .overlay-header {
                    padding: 1rem 1.5rem;
                }

                .overlay-body {
                    padding: 1.5rem;
                }

                .overlay-footer {
                    padding: 1rem 1.5rem;
                    flex-direction: column-reverse;
                }

                .overlay-footer .steady-btn {
                    width: 100%;
                }
            }
        `;

        document.head.appendChild(style);
    }
}

// Create global instance
const OverlayManager = new OverlayManagerClass();
window.OverlayManager = OverlayManager;

console.log('OverlayManager ready - Multi-tasking UI enabled 🚀');
/**
 * BASE OVERLAY v1.0
 * Foundation for all overlay components
 *
 * Extend this class to create custom overlays:
 *   class MyOverlay extends BaseOverlay {
 *       getTitle() { return 'My Custom Overlay'; }
 *       renderBody() { return '<div>My content</div>'; }
 *   }
 *
 * All overlays get these for free:
 * - Fade in/out animations (via SteadyUtils)
 * - ESC to close
 * - Click outside to close
 * - Loading states
 * - Error handling
 */

class BaseOverlay {
    constructor(id, data, zIndex) {
        this.id = id;
        this.data = data || {};
        this.zIndex = zIndex;
        this.isLoading = false;
        this.element = null;
    }

    /**
     * Render the overlay
     * Can be async if you need to load data first
     */
    async render() {
        // Create backdrop
        const backdrop = document.createElement('div');
        backdrop.id = this.id;
        backdrop.className = `overlay-backdrop ${this.getSize()}`;
        backdrop.style.zIndex = this.zIndex;

        backdrop.innerHTML = `
            <div class="overlay-container" id="${this.id}-container">
                <div class="overlay-header">
                    <h2 class="overlay-title">${API.escapeHtml(this.getTitle())}</h2>
                    <button class="overlay-close" aria-label="Close">×</button>
                </div>
                <div class="overlay-body" id="${this.id}-body">
                    ${this.isLoading ? this.renderLoading() : this.renderBody()}
                </div>
                ${this.hasFooter() ? `
                    <div class="overlay-footer" id="${this.id}-footer">
                        ${this.renderFooter()}
                    </div>
                ` : ''}
            </div>
        `;

        document.body.appendChild(backdrop);
        this.element = backdrop;

        // Fade in using SteadyUtils
        requestAnimationFrame(() => {
            backdrop.classList.add('overlay-visible');
        });

        // Attach event handlers
        this.attachEvents();

        // Call onMount hook
        await this.onMount();
    }

    /**
     * Attach event listeners
     */
    attachEvents() {
        const backdrop = this.element;
        const container = backdrop.querySelector('.overlay-container');
        const closeBtn = backdrop.querySelector('.overlay-close');

        // Close button
        closeBtn.onclick = () => OverlayManager.close(this.id);

        // Click outside to close (only if clicking directly on backdrop)
        backdrop.addEventListener('click', (e) => {
            if (e.target === backdrop) {
                OverlayManager.close(this.id);
            }
        });

        // Prevent clicks on container from closing
        container.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    }

    /**
     * Destroy the overlay
     */
    destroy() {
        if (!this.element) return;

        // Call onDestroy hook
        this.onDestroy();

        // Fade out using SteadyUtils
        this.element.classList.remove('overlay-visible');

        setTimeout(() => {
            if (this.element && this.element.parentNode) {
                this.element.parentNode.removeChild(this.element);
            }
            this.element = null;
        }, 300);
    }

    /**
     * Update overlay body content
     */
    updateBody(html) {
        const body = document.getElementById(`${this.id}-body`);
        if (body) {
            body.innerHTML = html;
            // Re-attach events if needed
            this.onBodyUpdate();
        }
    }

    /**
     * Update overlay footer content
     */
    updateFooter(html) {
        const footer = document.getElementById(`${this.id}-footer`);
        if (footer) {
            footer.innerHTML = html;
        }
    }

    /**
     * Show loading state
     */
    showLoading() {
        this.isLoading = true;
        this.updateBody(this.renderLoading());
    }

    /**
     * Hide loading state
     */
    hideLoading() {
        this.isLoading = false;
        this.updateBody(this.renderBody());
        this.onBodyUpdate();
    }

    /**
     * Show error in overlay
     */
    showError(message) {
        this.updateBody(`
            <div style="text-align: center; padding: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">❌</div>
                <h3 style="color: var(--danger); margin-bottom: 0.5rem;">Error</h3>
                <p style="color: var(--text-secondary);">${API.escapeHtml(message)}</p>
                <button class="steady-btn steady-btn-secondary" onclick="OverlayManager.close('${this.id}')">
                    Close
                </button>
            </div>
        `);
    }

    // =====================================================
    // OVERRIDE THESE METHODS IN YOUR OVERLAY
    // =====================================================

    /**
     * Get overlay title
     * @returns {string}
     */
    getTitle() {
        return 'Overlay';
    }

    /**
     * Get overlay size
     * @returns {string} 'overlay-sm', 'overlay-md', 'overlay-lg', 'overlay-xl', 'overlay-full'
     */
    getSize() {
        return 'overlay-md';
    }

    /**
     * Render body content
     * @returns {string} HTML string
     */
    renderBody() {
        return '<div>Override renderBody() in your overlay class</div>';
    }

    /**
     * Does this overlay have a footer?
     * @returns {boolean}
     */
    hasFooter() {
        return false;
    }

    /**
     * Render footer content
     * @returns {string} HTML string
     */
    renderFooter() {
        return '';
    }

    /**
     * Render loading state
     * @returns {string} HTML string
     */
    renderLoading() {
        return `
            <div style="text-align: center; padding: 3rem;">
                <div class="loading-spinner" style="display: inline-block;"></div>
                <p style="margin-top: 1rem; color: var(--text-secondary);">Loading...</p>
            </div>
        `;
    }

    /**
     * Called after overlay is mounted to DOM
     * Good place to load data, attach custom events, etc
     */
    async onMount() {
        // Override in subclass
    }

    /**
     * Called when overlay body is updated
     * Re-attach event listeners here if needed
     */
    onBodyUpdate() {
        // Override in subclass
    }

    /**
     * Called before overlay is destroyed
     * Cleanup custom event listeners, timers, etc
     */
    onDestroy() {
        // Override in subclass
    }
}

// Export to global scope
window.BaseOverlay = BaseOverlay;

console.log('BaseOverlay loaded - Overlay foundation ready 📦');
/**
 * BASE OVERLAY v1.0
 * Foundation for all overlay components
 *
 * Extend this class to create custom overlays:
 *   class MyOverlay extends BaseOverlay {
 *       getTitle() { return 'My Custom Overlay'; }
 *       renderBody() { return '<div>My content</div>'; }
 *   }
 *
 * All overlays get these for free:
 * - Fade in/out animations (via SteadyUtils)
 * - ESC to close
 * - Click outside to close
 * - Loading states
 * - Error handling
 */

class BaseOverlay {
    constructor(id, data, zIndex) {
        this.id = id;
        this.data = data || {};
        this.zIndex = zIndex;
        this.isLoading = false;
        this.element = null;
    }

    /**
     * Render the overlay
     * Can be async if you need to load data first
     */
    async render() {
        // Create backdrop
        const backdrop = document.createElement('div');
        backdrop.id = this.id;
        backdrop.className = `overlay-backdrop ${this.getSize()}`;
        backdrop.style.zIndex = this.zIndex;

        backdrop.innerHTML = `
            <div class="overlay-container" id="${this.id}-container">
                <div class="overlay-header">
                    <h2 class="overlay-title">${API.escapeHtml(this.getTitle())}</h2>
                    <button class="overlay-close" aria-label="Close">×</button>
                </div>
                <div class="overlay-body" id="${this.id}-body">
                    ${this.isLoading ? this.renderLoading() : this.renderBody()}
                </div>
                ${this.hasFooter() ? `
                    <div class="overlay-footer" id="${this.id}-footer">
                        ${this.renderFooter()}
                    </div>
                ` : ''}
            </div>
        `;

        document.body.appendChild(backdrop);
        this.element = backdrop;

        // Fade in using SteadyUtils
        requestAnimationFrame(() => {
            backdrop.classList.add('overlay-visible');
        });

        // Attach event handlers
        this.attachEvents();

        // Call onMount hook
        await this.onMount();
    }

    /**
     * Attach event listeners
     */
    attachEvents() {
        const backdrop = this.element;
        const container = backdrop.querySelector('.overlay-container');
        const closeBtn = backdrop.querySelector('.overlay-close');

        // Close button
        closeBtn.onclick = () => OverlayManager.close(this.id);

        // Click outside to close (only if clicking directly on backdrop)
        backdrop.addEventListener('click', (e) => {
            if (e.target === backdrop) {
                OverlayManager.close(this.id);
            }
        });

        // Prevent clicks on container from closing
        container.addEventListener('click', (e) => {
            e.stopPropagation();
        });
    }

    /**
     * Destroy the overlay
     */
    destroy() {
        if (!this.element) return;

        // Call onDestroy hook
        this.onDestroy();

        // Fade out using SteadyUtils
        this.element.classList.remove('overlay-visible');

        setTimeout(() => {
            if (this.element && this.element.parentNode) {
                this.element.parentNode.removeChild(this.element);
            }
            this.element = null;
        }, 300);
    }

    /**
     * Update overlay body content
     */
    updateBody(html) {
        const body = document.getElementById(`${this.id}-body`);
        if (body) {
            body.innerHTML = html;
            // Re-attach events if needed
            this.onBodyUpdate();
        }
    }

    /**
     * Update overlay footer content
     */
    updateFooter(html) {
        const footer = document.getElementById(`${this.id}-footer`);
        if (footer) {
            footer.innerHTML = html;
        }
    }

    /**
     * Show loading state
     */
    showLoading() {
        this.isLoading = true;
        this.updateBody(this.renderLoading());
    }

    /**
     * Hide loading state
     */
    hideLoading() {
        this.isLoading = false;
        this.updateBody(this.renderBody());
        this.onBodyUpdate();
    }

    /**
     * Show error in overlay
     */
    showError(message) {
        this.updateBody(`
            <div style="text-align: center; padding: 2rem;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">❌</div>
                <h3 style="color: var(--danger); margin-bottom: 0.5rem;">Error</h3>
                <p style="color: var(--text-secondary);">${API.escapeHtml(message)}</p>
                <button class="steady-btn steady-btn-secondary" onclick="OverlayManager.close('${this.id}')">
                    Close
                </button>
            </div>
        `);
    }

    // =====================================================
    // OVERRIDE THESE METHODS IN YOUR OVERLAY
    // =====================================================

    /**
     * Get overlay title
     * @returns {string}
     */
    getTitle() {
        return 'Overlay';
    }

    /**
     * Get overlay size
     * @returns {string} 'overlay-sm', 'overlay-md', 'overlay-lg', 'overlay-xl', 'overlay-full'
     */
    getSize() {
        return 'overlay-md';
    }

    /**
     * Render body content
     * @returns {string} HTML string
     */
    renderBody() {
        return '<div>Override renderBody() in your overlay class</div>';
    }

    /**
     * Does this overlay have a footer?
     * @returns {boolean}
     */
    hasFooter() {
        return false;
    }

    /**
     * Render footer content
     * @returns {string} HTML string
     */
    renderFooter() {
        return '';
    }

    /**
     * Render loading state
     * @returns {string} HTML string
     */
    renderLoading() {
        return `
            <div style="text-align: center; padding: 3rem;">
                <div class="loading-spinner" style="display: inline-block;"></div>
                <p style="margin-top: 1rem; color: var(--text-secondary);">Loading...</p>
            </div>
        `;
    }

    /**
     * Called after overlay is mounted to DOM
     * Good place to load data, attach custom events, etc
     */
    async onMount() {
        // Override in subclass
    }

    /**
     * Called when overlay body is updated
     * Re-attach event listeners here if needed
     */
    onBodyUpdate() {
        // Override in subclass
    }

    /**
     * Called before overlay is destroyed
     * Cleanup custom event listeners, timers, etc
     */
    onDestroy() {
        // Override in subclass
    }
}

// Export to global scope
window.BaseOverlay = BaseOverlay;

console.log('BaseOverlay loaded - Overlay foundation ready 📦');
/**
 * JOB DETAIL OVERLAY
 * Shows full job information with profit/loss breakdown
 *
 * Usage:
 *   OverlayManager.open('job-detail', { jobId: '123' });
 */

class JobDetailOverlay extends BaseOverlay {
    async onMount() {
        this.showLoading();

        try {
            const jobId = this.data.jobId;
            const jobs = await API.getJobs();
            this.job = jobs.find(j => j.id === jobId);

            if (!this.job) {
                throw new Error('Job not found');
            }

            // Load associated lead if exists
            if (this.job.lead_id) {
                this.lead = await API.getLeadById(this.job.lead_id);
            }

            this.hideLoading();
        } catch (error) {
            this.showError(API.handleAPIError(error, 'Load Job'));
        }
    }

    getTitle() {
        return this.job ? `💼 ${this.job.title}` : 'Job Details';
    }

    getSize() {
        return 'overlay-lg';
    }

    renderBody() {
        if (!this.job) return '';

        const job = this.job;
        const profit = parseFloat(job.profit) || 0;
        const margin = parseFloat(job.profit_margin) || 0;

        return `
            <div class="job-detail-grid">
                <!-- Job Info -->
                <div class="detail-section">
                    <h3 class="section-title">Job Information</h3>
                    <div class="detail-row">
                        <span class="detail-label">Title:</span>
                        <span class="detail-value">${API.escapeHtml(job.title)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Type:</span>
                        <span class="detail-value">${API.escapeHtml(job.job_type || 'N/A')}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value">
                            <span class="status-badge status-${API.escapeHtml(job.status || 'scheduled')}">
                                ${API.escapeHtml(job.status || 'scheduled')}
                            </span>
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Priority:</span>
                        <span class="detail-value">${API.escapeHtml(job.priority || 'medium')}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Scheduled Date:</span>
                        <span class="detail-value">${job.scheduled_date ? SteadyUtils.formatDate(job.scheduled_date, 'long') : 'Not scheduled'}</span>
                    </div>
                    ${job.scheduled_time ? `
                        <div class="detail-row">
                            <span class="detail-label">Time:</span>
                            <span class="detail-value">${API.escapeHtml(String(job.scheduled_time))}</span>
                        </div>
                    ` : ''}
                    ${job.duration_hours ? `
                        <div class="detail-row">
                            <span class="detail-label">Duration:</span>
                            <span class="detail-value">${API.escapeHtml(String(job.duration_hours))} hours</span>
                        </div>
                    ` : ''}
                    ${job.location ? `
                        <div class="detail-row">
                            <span class="detail-label">Location:</span>
                            <span class="detail-value">${API.escapeHtml(job.location)}</span>
                        </div>
                    ` : ''}
                </div>

                <!-- Financial Summary -->
                <div class="detail-section financial-summary">
                    <h3 class="section-title">Financial Summary</h3>
                    <div class="financial-card ${profit >= 0 ? 'profit-positive' : 'profit-negative'}">
                        <div class="financial-big">
                            <div class="financial-label">Profit</div>
                            <div class="financial-value">${SteadyUtils.formatCurrency(profit)}</div>
                            <div class="financial-meta">${margin.toFixed(1)}% margin</div>
                        </div>
                    </div>

                    <div class="financial-breakdown">
                        <div class="breakdown-row">
                            <span class="breakdown-label">Revenue:</span>
                            <span class="breakdown-value revenue">${SteadyUtils.formatCurrency(parseFloat(job.final_price || job.quoted_price) || 0)}</span>
                        </div>
                        <div class="breakdown-row">
                            <span class="breakdown-label">Total Cost:</span>
                            <span class="breakdown-value cost">-${SteadyUtils.formatCurrency(parseFloat(job.total_cost) || 0)}</span>
                        </div>
                        <div class="breakdown-divider"></div>
                        <div class="breakdown-row breakdown-total">
                            <span class="breakdown-label">Net Profit:</span>
                            <span class="breakdown-value ${profit >= 0 ? 'profit' : 'loss'}">${SteadyUtils.formatCurrency(profit)}</span>
                        </div>
                    </div>
                </div>

                <!-- Cost Breakdown -->
                <div class="detail-section">
                    <h3 class="section-title">Cost Breakdown</h3>
                    <div class="detail-row">
                        <span class="detail-label">Material Cost:</span>
                        <span class="detail-value">${SteadyUtils.formatCurrency(parseFloat(job.material_cost) || 0)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Labor Hours:</span>
                        <span class="detail-value">${API.escapeHtml(String(job.labor_hours || 0))} hours</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Labor Rate:</span>
                        <span class="detail-value">${SteadyUtils.formatCurrency(parseFloat(job.labor_rate) || 0)}/hr</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Labor Cost:</span>
                        <span class="detail-value">${SteadyUtils.formatCurrency((job.labor_hours || 0) * (parseFloat(job.labor_rate) || 0))}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Other Expenses:</span>
                        <span class="detail-value">${SteadyUtils.formatCurrency(parseFloat(job.other_expenses) || 0)}</span>
                    </div>
                </div>

                <!-- Pricing -->
                <div class="detail-section">
                    <h3 class="section-title">Pricing</h3>
                    <div class="detail-row">
                        <span class="detail-label">Quoted Price:</span>
                        <span class="detail-value">${SteadyUtils.formatCurrency(parseFloat(job.quoted_price) || 0)}</span>
                    </div>
                    ${job.final_price ? `
                        <div class="detail-row">
                            <span class="detail-label">Final Price:</span>
                            <span class="detail-value">${SteadyUtils.formatCurrency(parseFloat(job.final_price))}</span>
                        </div>
                    ` : ''}
                    ${job.invoice_number ? `
                        <div class="detail-row">
                            <span class="detail-label">Invoice #:</span>
                            <span class="detail-value">${API.escapeHtml(job.invoice_number)}</span>
                        </div>
                    ` : ''}
                    <div class="detail-row">
                        <span class="detail-label">Payment Status:</span>
                        <span class="detail-value">
                            <span class="status-badge status-${API.escapeHtml(job.payment_status || 'pending')}">
                                ${API.escapeHtml(job.payment_status || 'pending')}
                            </span>
                        </span>
                    </div>
                </div>

                <!-- Associated Lead -->
                ${this.lead ? `
                    <div class="detail-section detail-section-full">
                        <h3 class="section-title">Associated Lead</h3>
                        <div class="lead-card" onclick="OverlayManager.open('lead-detail', { leadId: '${this.lead.id}' })">
                            <div class="lead-name">${API.escapeHtml(this.lead.name)}</div>
                            <div class="lead-meta">
                                ${this.lead.company ? API.escapeHtml(this.lead.company) : 'No company'} •
                                ${this.lead.email ? API.escapeHtml(this.lead.email) : 'No email'}
                            </div>
                        </div>
                    </div>
                ` : ''}

                <!-- Materials -->
                ${job.materials && Array.isArray(job.materials) && job.materials.length > 0 ? `
                    <div class="detail-section detail-section-full">
                        <h3 class="section-title">Materials Used</h3>
                        <div class="materials-table">
                            ${job.materials.map(mat => `
                                <div class="material-row">
                                    <span class="material-name">${API.escapeHtml(mat.name)}</span>
                                    <span class="material-qty">${API.escapeHtml(String(mat.quantity))} ${API.escapeHtml(mat.unit || 'units')}</span>
                                    <span class="material-cost">${SteadyUtils.formatCurrency(mat.cost || 0)}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Notes/Description -->
                ${job.notes ? `
                    <div class="detail-section detail-section-full">
                        <h3 class="section-title">Notes</h3>
                        <div class="notes-content">${API.escapeHtml(job.notes)}</div>
                    </div>
                ` : ''}

                ${job.description ? `
                    <div class="detail-section detail-section-full">
                        <h3 class="section-title">Description</h3>
                        <div class="notes-content">${API.escapeHtml(job.description)}</div>
                    </div>
                ` : ''}
            </div>

            <style>
                .job-detail-grid {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 1.5rem;
                }

                .detail-section-full {
                    grid-column: 1 / -1;
                }

                .financial-summary {
                    grid-column: 1 / -1;
                }

                .financial-card {
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    border-radius: var(--radius-lg);
                    padding: 2rem;
                    color: white;
                    margin-bottom: 1.5rem;
                }

                .financial-card.profit-negative {
                    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                }

                .financial-big {
                    text-align: center;
                }

                .financial-label {
                    font-size: 0.875rem;
                    opacity: 0.9;
                    margin-bottom: 0.5rem;
                }

                .financial-value {
                    font-size: 2.5rem;
                    font-weight: 900;
                }

                .financial-meta {
                    font-size: 1rem;
                    opacity: 0.9;
                    margin-top: 0.5rem;
                }

                .financial-breakdown {
                    background: var(--background);
                    border-radius: var(--radius);
                    padding: 1.5rem;
                }

                .breakdown-row {
                    display: flex;
                    justify-content: space-between;
                    padding: 0.75rem 0;
                }

                .breakdown-label {
                    color: var(--text-secondary);
                }

                .breakdown-value {
                    font-weight: 600;
                    color: var(--text-primary);
                }

                .breakdown-value.revenue {
                    color: var(--success);
                }

                .breakdown-value.cost {
                    color: var(--text-secondary);
                }

                .breakdown-value.profit {
                    color: var(--success);
                }

                .breakdown-value.loss {
                    color: var(--danger);
                }

                .breakdown-divider {
                    border-top: 2px solid var(--border);
                    margin: 0.5rem 0;
                }

                .breakdown-total {
                    font-size: 1.125rem;
                }

                .status-badge {
                    display: inline-block;
                    padding: 0.25rem 0.75rem;
                    border-radius: var(--radius);
                    font-size: 0.75rem;
                    font-weight: 600;
                    text-transform: uppercase;
                }

                .status-scheduled {
                    background: #3b82f6;
                    color: white;
                }

                .status-in_progress {
                    background: #f59e0b;
                    color: white;
                }

                .status-completed {
                    background: #10b981;
                    color: white;
                }

                .status-cancelled {
                    background: #6b7280;
                    color: white;
                }

                .status-pending {
                    background: #f59e0b;
                    color: white;
                }

                .status-paid {
                    background: #10b981;
                    color: white;
                }

                .status-overdue {
                    background: #ef4444;
                    color: white;
                }

                .lead-card,
                .materials-table .material-row {
                    background: var(--background);
                    padding: 1rem;
                    border-radius: var(--radius);
                    cursor: pointer;
                    transition: var(--transition);
                }

                .lead-card:hover {
                    background: var(--surface-hover);
                    transform: translateY(-2px);
                }

                .lead-name {
                    font-weight: 600;
                    color: var(--text-primary);
                    margin-bottom: 0.25rem;
                }

                .lead-meta {
                    font-size: 0.875rem;
                    color: var(--text-secondary);
                }

                .materials-table {
                    display: flex;
                    flex-direction: column;
                    gap: 0.5rem;
                }

                .material-row {
                    display: grid;
                    grid-template-columns: 1fr auto auto;
                    gap: 1rem;
                    align-items: center;
                    cursor: default;
                }

                .material-name {
                    font-weight: 500;
                }

                .material-qty {
                    color: var(--text-secondary);
                    font-size: 0.875rem;
                }

                .material-cost {
                    font-weight: 600;
                }

                @media (max-width: 768px) {
                    .job-detail-grid {
                        grid-template-columns: 1fr;
                    }

                    .financial-value {
                        font-size: 2rem;
                    }
                }
            </style>
        `;
    }

    hasFooter() {
        return true;
    }

    renderFooter() {
        return `
            <button class="steady-btn steady-btn-secondary" onclick="OverlayManager.close('${this.id}')">
                Close
            </button>
            ${this.job.status !== 'completed' ? `
                <button class="steady-btn steady-btn-primary" onclick="alert('Edit feature coming soon!')">
                    Edit Job
                </button>
            ` : ''}
        `;
    }
}

// Register this overlay type
OverlayManager.register('job-detail', JobDetailOverlay);

console.log('JobDetailOverlay registered ✅');
/**
 * LEAD DETAIL OVERLAY
 * Shows full lead information in a popup
 *
 * Usage:
 *   OverlayManager.open('lead-detail', { leadId: '123' });
 */

class LeadDetailOverlay extends BaseOverlay {
    async onMount() {
        this.showLoading();

        try {
            // Load lead data
            this.lead = await API.getLeadById(this.data.leadId);

            // Load associated jobs
            this.jobs = await API.getJobsByLead(this.data.leadId);

            this.hideLoading();
        } catch (error) {
            this.showError(API.handleAPIError(error, 'Load Lead'));
        }
    }

    getTitle() {
        return this.lead ? `${this.lead.name}` : 'Lead Details';
    }

    getSize() {
        return 'overlay-lg';
    }

    renderBody() {
        if (!this.lead) return '';

        const lead = this.lead;

        return `
            <div class="lead-detail-grid">
                <!-- Contact Information -->
                <div class="detail-section">
                    <h3 class="section-title">Contact Information</h3>
                    <div class="detail-row">
                        <span class="detail-label">Name:</span>
                        <span class="detail-value">${API.escapeHtml(lead.name)}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Email:</span>
                        <span class="detail-value">${lead.email ? `<a href="mailto:${API.escapeHtml(lead.email)}">${API.escapeHtml(lead.email)}</a>` : 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Phone:</span>
                        <span class="detail-value">${lead.phone ? `<a href="tel:${API.escapeHtml(lead.phone)}">${API.escapeHtml(lead.phone)}</a>` : 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Company:</span>
                        <span class="detail-value">${API.escapeHtml(lead.company || 'N/A')}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Position:</span>
                        <span class="detail-value">${API.escapeHtml(lead.position || 'N/A')}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Department:</span>
                        <span class="detail-value">${API.escapeHtml(lead.department || 'N/A')}</span>
                    </div>
                </div>

                <!-- Lead Status -->
                <div class="detail-section">
                    <h3 class="section-title">Lead Status</h3>
                    <div class="detail-row">
                        <span class="detail-label">Status:</span>
                        <span class="detail-value">
                            <span class="status-badge" style="background: ${API.getStatusColor(lead.status)}">
                                ${API.escapeHtml(lead.status || 'new')}
                            </span>
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Type:</span>
                        <span class="detail-value">${API.escapeHtml(lead.type || 'N/A')}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Source:</span>
                        <span class="detail-value">${API.escapeHtml(lead.source || 'N/A')}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Quality Score:</span>
                        <span class="detail-value">${lead.quality_score ? `${API.escapeHtml(String(lead.quality_score))}/10` : 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Deal Stage:</span>
                        <span class="detail-value">${API.escapeHtml(lead.deal_stage || 'N/A')}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Win Probability:</span>
                        <span class="detail-value">${lead.win_probability ? `${API.escapeHtml(String(lead.win_probability))}%` : 'N/A'}</span>
                    </div>
                </div>

                <!-- Financial -->
                <div class="detail-section">
                    <h3 class="section-title">Financial</h3>
                    <div class="detail-row">
                        <span class="detail-label">Potential Value:</span>
                        <span class="detail-value" style="font-weight: 600; color: var(--success);">
                            ${lead.potential_value ? SteadyUtils.formatCurrency(parseFloat(lead.potential_value)) : 'N/A'}
                        </span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Weighted Value:</span>
                        <span class="detail-value">
                            ${lead.potential_value && lead.win_probability ?
                                SteadyUtils.formatCurrency(parseFloat(lead.potential_value) * (lead.win_probability / 100)) : 'N/A'}
                        </span>
                    </div>
                </div>

                <!-- Next Actions -->
                <div class="detail-section">
                    <h3 class="section-title">Next Actions</h3>
                    <div class="detail-row">
                        <span class="detail-label">Next Action:</span>
                        <span class="detail-value">${API.escapeHtml(lead.next_action || 'No action set')}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Follow-up Date:</span>
                        <span class="detail-value">${lead.follow_up_date ? SteadyUtils.formatDate(lead.follow_up_date, 'long') : 'N/A'}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Last Contact:</span>
                        <span class="detail-value">${lead.last_contact_date ? SteadyUtils.formatDate(lead.last_contact_date, 'relative') : 'Never'}</span>
                    </div>
                </div>

                <!-- Tags -->
                ${lead.tags && lead.tags.length > 0 ? `
                    <div class="detail-section">
                        <h3 class="section-title">Tags</h3>
                        <div class="tags-container">
                            ${lead.tags.map(tag => `
                                <span class="tag">${API.escapeHtml(tag)}</span>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Notes -->
                ${lead.notes ? `
                    <div class="detail-section detail-section-full">
                        <h3 class="section-title">Notes</h3>
                        <div class="notes-content">${API.escapeHtml(lead.notes)}</div>
                    </div>
                ` : ''}

                <!-- Associated Jobs -->
                ${this.jobs && this.jobs.length > 0 ? `
                    <div class="detail-section detail-section-full">
                        <h3 class="section-title">Associated Jobs (${this.jobs.length})</h3>
                        <div class="jobs-list">
                            ${this.jobs.map(job => `
                                <div class="job-card" onclick="OverlayManager.open('job-detail', { jobId: '${job.id}' })">
                                    <div class="job-title">${API.escapeHtml(job.title)}</div>
                                    <div class="job-meta">
                                        ${job.scheduled_date ? SteadyUtils.formatDate(job.scheduled_date, 'short') : 'No date'} •
                                        ${job.quoted_price ? SteadyUtils.formatCurrency(job.quoted_price) : 'No price'}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                ` : ''}

                <!-- Created Date -->
                <div class="detail-section detail-section-full">
                    <div class="detail-row">
                        <span class="detail-label">Created:</span>
                        <span class="detail-value">${SteadyUtils.formatDate(lead.created_at, 'datetime')}</span>
                    </div>
                </div>
            </div>

            <style>
                .lead-detail-grid {
                    display: grid;
                    grid-template-columns: repeat(2, 1fr);
                    gap: 2rem;
                }

                .detail-section {
                    background: var(--surface);
                    border: 1px solid var(--border);
                    border-radius: var(--radius);
                    padding: 1.5rem;
                }

                .detail-section-full {
                    grid-column: 1 / -1;
                }

                .section-title {
                    font-size: 0.875rem;
                    font-weight: 700;
                    color: var(--text-secondary);
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin-bottom: 1rem;
                }

                .detail-row {
                    display: flex;
                    justify-content: space-between;
                    padding: 0.75rem 0;
                    border-bottom: 1px solid var(--border);
                }

                .detail-row:last-child {
                    border-bottom: none;
                }

                .detail-label {
                    font-weight: 500;
                    color: var(--text-secondary);
                }

                .detail-value {
                    color: var(--text-primary);
                    text-align: right;
                }

                .status-badge {
                    display: inline-block;
                    padding: 0.25rem 0.75rem;
                    border-radius: var(--radius);
                    color: white;
                    font-size: 0.75rem;
                    font-weight: 600;
                    text-transform: uppercase;
                }

                .tags-container {
                    display: flex;
                    flex-wrap: wrap;
                    gap: 0.5rem;
                }

                .tag {
                    background: var(--primary-light);
                    color: var(--primary);
                    padding: 0.25rem 0.75rem;
                    border-radius: var(--radius);
                    font-size: 0.75rem;
                    font-weight: 500;
                }

                .notes-content {
                    background: var(--background);
                    padding: 1rem;
                    border-radius: var(--radius);
                    white-space: pre-wrap;
                    color: var(--text-primary);
                }

                .jobs-list {
                    display: grid;
                    gap: 0.75rem;
                }

                .job-card {
                    background: var(--background);
                    padding: 1rem;
                    border-radius: var(--radius);
                    cursor: pointer;
                    transition: var(--transition);
                }

                .job-card:hover {
                    background: var(--surface-hover);
                    transform: translateY(-2px);
                }

                .job-title {
                    font-weight: 600;
                    color: var(--text-primary);
                    margin-bottom: 0.25rem;
                }

                .job-meta {
                    font-size: 0.875rem;
                    color: var(--text-secondary);
                }

                @media (max-width: 768px) {
                    .lead-detail-grid {
                        grid-template-columns: 1fr;
                        gap: 1rem;
                    }

                    .detail-row {
                        flex-direction: column;
                        gap: 0.25rem;
                    }

                    .detail-value {
                        text-align: left;
                    }
                }
            </style>
        `;
    }

    hasFooter() {
        return true;
    }

    renderFooter() {
        return `
            <button class="steady-btn steady-btn-secondary" onclick="OverlayManager.close('${this.id}')">
                Close
            </button>
            <button class="steady-btn steady-btn-primary" onclick="alert('Edit feature coming soon!')">
                Edit Lead
            </button>
        `;
    }
}

// Register this overlay type
OverlayManager.register('lead-detail', LeadDetailOverlay);

console.log('LeadDetailOverlay registered ✅');
/**
 * QUICK ADD JOB OVERLAY
 * Fast job creation from anywhere
 *
 * Usage:
 *   OverlayManager.open('quick-add-job');
 *   OverlayManager.open('quick-add-job', { lead_id: '123' }); // Pre-link to lead
 */

class QuickAddJobOverlay extends BaseOverlay {
    async onMount() {
        // Load leads for association picker
        try {
            const leadsData = await API.getLeads();
            this.leads = leadsData.all || [];
        } catch (error) {
            this.leads = [];
        }
    }

    getTitle() {
        return '💼 Quick Add Job';
    }

    getSize() {
        return 'overlay-lg';
    }

    renderBody() {
        const prefill = this.data || {};

        return `
            <form id="${this.id}-form" class="quick-add-job-form">
                <div class="form-section">
                    <h3 class="form-section-title">Job Details</h3>

                    <div class="form-row">
                        <label for="${this.id}-title">Job Title *</label>
                        <input
                            type="text"
                            id="${this.id}-title"
                            class="form-input"
                            required
                            placeholder="Install kitchen cabinets"
                            value="${API.escapeHtml(prefill.title || '')}"
                            autocomplete="off">
                    </div>

                    <div class="form-row-split">
                        <div class="form-row">
                            <label for="${this.id}-type">Type</label>
                            <select id="${this.id}-type" class="form-input">
                                <option value="service">Service</option>
                                <option value="product">Product</option>
                                <option value="consultation">Consultation</option>
                                <option value="project">Project</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <label for="${this.id}-priority">Priority</label>
                            <select id="${this.id}-priority" class="form-input">
                                <option value="low">Low</option>
                                <option value="medium" selected>Medium</option>
                                <option value="high">High</option>
                                <option value="urgent">Urgent</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-row-split">
                        <div class="form-row">
                            <label for="${this.id}-date">Scheduled Date</label>
                            <input
                                type="date"
                                id="${this.id}-date"
                                class="form-input"
                                value="${prefill.scheduled_date || ''}">
                        </div>

                        <div class="form-row">
                            <label for="${this.id}-time">Time</label>
                            <input
                                type="time"
                                id="${this.id}-time"
                                class="form-input"
                                value="${prefill.scheduled_time || ''}">
                        </div>
                    </div>

                    <div class="form-row">
                        <label for="${this.id}-lead">Associate with Lead (optional)</label>
                        <select id="${this.id}-lead" class="form-input">
                            <option value="">None</option>
                            ${this.leads ? this.leads.map(lead => `
                                <option value="${lead.id}" ${prefill.lead_id === lead.id ? 'selected' : ''}>
                                    ${API.escapeHtml(lead.name)} ${lead.company ? `- ${API.escapeHtml(lead.company)}` : ''}
                                </option>
                            `).join('') : ''}
                        </select>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="form-section-title">Pricing & Costs</h3>

                    <div class="form-row">
                        <label for="${this.id}-quoted">Quoted Price ($)</label>
                        <input
                            type="number"
                            id="${this.id}-quoted"
                            class="form-input"
                            min="0"
                            step="0.01"
                            placeholder="1500.00"
                            value="${prefill.quoted_price || ''}">
                    </div>

                    <div class="form-row-split">
                        <div class="form-row">
                            <label for="${this.id}-material">Material Cost ($)</label>
                            <input
                                type="number"
                                id="${this.id}-material"
                                class="form-input"
                                min="0"
                                step="0.01"
                                placeholder="500.00"
                                value="${prefill.material_cost || '0'}">
                        </div>

                        <div class="form-row">
                            <label for="${this.id}-other">Other Expenses ($)</label>
                            <input
                                type="number"
                                id="${this.id}-other"
                                class="form-input"
                                min="0"
                                step="0.01"
                                placeholder="50.00"
                                value="${prefill.other_expenses || '0'}">
                        </div>
                    </div>

                    <div class="form-row-split">
                        <div class="form-row">
                            <label for="${this.id}-labor-hours">Labor Hours</label>
                            <input
                                type="number"
                                id="${this.id}-labor-hours"
                                class="form-input"
                                min="0"
                                step="0.5"
                                placeholder="8"
                                value="${prefill.labor_hours || '0'}">
                        </div>

                        <div class="form-row">
                            <label for="${this.id}-labor-rate">Labor Rate ($/hr)</label>
                            <input
                                type="number"
                                id="${this.id}-labor-rate"
                                class="form-input"
                                min="0"
                                step="0.01"
                                placeholder="50.00"
                                value="${prefill.labor_rate || '0'}">
                        </div>
                    </div>

                    <!-- Profit Preview -->
                    <div id="${this.id}-profit-preview" class="profit-preview">
                        <div class="profit-label">Estimated Profit:</div>
                        <div class="profit-value">$0.00</div>
                        <div class="profit-margin">0% margin</div>
                    </div>
                </div>

                <div class="form-section">
                    <h3 class="form-section-title">Additional Info</h3>

                    <div class="form-row">
                        <label for="${this.id}-location">Location</label>
                        <input
                            type="text"
                            id="${this.id}-location"
                            class="form-input"
                            placeholder="123 Main St, City, State"
                            value="${API.escapeHtml(prefill.location || '')}"
                            autocomplete="off">
                    </div>

                    <div class="form-row">
                        <label for="${this.id}-notes">Notes</label>
                        <textarea
                            id="${this.id}-notes"
                            class="form-input"
                            rows="3"
                            placeholder="Additional job details...">${API.escapeHtml(prefill.notes || '')}</textarea>
                    </div>
                </div>
            </form>

            <style>
                .quick-add-job-form {
                    display: flex;
                    flex-direction: column;
                    gap: 2rem;
                }

                .form-section {
                    display: flex;
                    flex-direction: column;
                    gap: 1rem;
                }

                .form-section-title {
                    font-size: 0.875rem;
                    font-weight: 700;
                    color: var(--text-secondary);
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin: 0;
                    padding-bottom: 0.5rem;
                    border-bottom: 2px solid var(--border);
                }

                .profit-preview {
                    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
                    border-radius: var(--radius-lg);
                    padding: 1.5rem;
                    text-align: center;
                    color: white;
                    margin-top: 1rem;
                }

                .profit-preview.negative {
                    background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
                }

                .profit-label {
                    font-size: 0.875rem;
                    opacity: 0.9;
                    margin-bottom: 0.5rem;
                }

                .profit-value {
                    font-size: 2rem;
                    font-weight: 900;
                }

                .profit-margin {
                    font-size: 0.875rem;
                    opacity: 0.9;
                    margin-top: 0.25rem;
                }
            </style>
        `;
    }

    hasFooter() {
        return true;
    }

    renderFooter() {
        return `
            <button class="steady-btn steady-btn-secondary" onclick="OverlayManager.close('${this.id}')">
                Cancel
            </button>
            <button class="steady-btn steady-btn-primary" id="${this.id}-submit">
                Create Job
            </button>
        `;
    }

    onBodyUpdate() {
        // Attach submit handler
        const submitBtn = document.getElementById(`${this.id}-submit`);
        if (submitBtn) {
            submitBtn.onclick = () => this.handleSubmit();
        }

        // Submit on Enter in form
        const form = document.getElementById(`${this.id}-form`);
        if (form) {
            form.onsubmit = (e) => {
                e.preventDefault();
                this.handleSubmit();
            };
        }

        // Calculate profit as user types
        const inputs = ['quoted', 'material', 'other', 'labor-hours', 'labor-rate'];
        inputs.forEach(field => {
            const input = document.getElementById(`${this.id}-${field}`);
            if (input) {
                input.addEventListener('input', () => this.updateProfitPreview());
            }
        });

        // Initial calculation
        this.updateProfitPreview();

        // Focus first input
        setTimeout(() => {
            document.getElementById(`${this.id}-title`)?.focus();
        }, 100);
    }

    updateProfitPreview() {
        const quoted = parseFloat(document.getElementById(`${this.id}-quoted`)?.value || 0);
        const material = parseFloat(document.getElementById(`${this.id}-material`)?.value || 0);
        const other = parseFloat(document.getElementById(`${this.id}-other`)?.value || 0);
        const laborHours = parseFloat(document.getElementById(`${this.id}-labor-hours`)?.value || 0);
        const laborRate = parseFloat(document.getElementById(`${this.id}-labor-rate`)?.value || 0);

        const laborCost = laborHours * laborRate;
        const totalCost = material + other + laborCost;
        const profit = quoted - totalCost;
        const margin = quoted > 0 ? (profit / quoted) * 100 : 0;

        const preview = document.getElementById(`${this.id}-profit-preview`);
        if (preview) {
            preview.querySelector('.profit-value').textContent = SteadyUtils.formatCurrency(profit);
            preview.querySelector('.profit-margin').textContent = `${margin.toFixed(1)}% margin`;

            if (profit < 0) {
                preview.classList.add('negative');
            } else {
                preview.classList.remove('negative');
            }
        }
    }

    async handleSubmit() {
        const getTitle = () => document.getElementById(`${this.id}-title`)?.value.trim();
        const getType = () => document.getElementById(`${this.id}-type`)?.value;
        const getPriority = () => document.getElementById(`${this.id}-priority`)?.value;
        const getDate = () => document.getElementById(`${this.id}-date`)?.value;
        const getTime = () => document.getElementById(`${this.id}-time`)?.value;
        const getLead = () => document.getElementById(`${this.id}-lead`)?.value;
        const getQuoted = () => document.getElementById(`${this.id}-quoted`)?.value;
        const getMaterial = () => document.getElementById(`${this.id}-material`)?.value;
        const getOther = () => document.getElementById(`${this.id}-other`)?.value;
        const getLaborHours = () => document.getElementById(`${this.id}-labor-hours`)?.value;
        const getLaborRate = () => document.getElementById(`${this.id}-labor-rate`)?.value;
        const getLocation = () => document.getElementById(`${this.id}-location`)?.value.trim();
        const getNotes = () => document.getElementById(`${this.id}-notes`)?.value.trim();

        const title = getTitle();

        if (!title) {
            SteadyUtils.shake(`#${this.id}-title`);
            toast('Job title is required', 'error');
            return;
        }

        const submitBtn = document.getElementById(`${this.id}-submit`);
        submitBtn.disabled = true;
        submitBtn.textContent = 'Creating...';

        try {
            const jobData = {
                title,
                job_type: getType(),
                priority: getPriority(),
                scheduled_date: getDate() || null,
                scheduled_time: getTime() || null,
                lead_id: getLead() || null,
                quoted_price: getQuoted() ? parseFloat(getQuoted()) : 0,
                material_cost: getMaterial() ? parseFloat(getMaterial()) : 0,
                other_expenses: getOther() ? parseFloat(getOther()) : 0,
                labor_hours: getLaborHours() ? parseFloat(getLaborHours()) : 0,
                labor_rate: getLaborRate() ? parseFloat(getLaborRate()) : 0,
                location: getLocation() || null,
                notes: getNotes() || null,
                status: 'scheduled'
            };

            await API.createJob(jobData);

            toast('Job created successfully! 💼', 'success');

            // Close overlay
            OverlayManager.close(this.id);

            // Reload current page to show new job
            if (window.loadPage) {
                const currentPage = document.querySelector('.nav-link.active')?.getAttribute('data-page') || 'dashboard';
                window.loadPage(currentPage);
            }

        } catch (error) {
            console.error('Quick add job error:', error);
            toast(API.handleAPIError(error, 'Quick Add Job'), 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Create Job';
        }
    }
}

// Register this overlay type
OverlayManager.register('quick-add-job', QuickAddJobOverlay);

console.log('QuickAddJobOverlay registered ✅');
/**
 * QUICK ADD LEAD OVERLAY
 * Fast lead creation from anywhere
 *
 * Usage:
 *   OverlayManager.open('quick-add-lead');
 *   OverlayManager.open('quick-add-lead', { name: 'John Smith', company: 'TechCorp' }); // Pre-fill
 */

class QuickAddLeadOverlay extends BaseOverlay {
    getTitle() {
        return '⚡ Quick Add Lead';
    }

    getSize() {
        return 'overlay-md';
    }

    renderBody() {
        const prefill = this.data || {};

        return `
            <form id="${this.id}-form" class="quick-add-form">
                <div class="form-row">
                    <label for="${this.id}-name">Name *</label>
                    <input
                        type="text"
                        id="${this.id}-name"
                        class="form-input"
                        required
                        placeholder="John Smith"
                        value="${API.escapeHtml(prefill.name || '')}"
                        autocomplete="off">
                </div>

                <div class="form-row">
                    <label for="${this.id}-email">Email</label>
                    <input
                        type="email"
                        id="${this.id}-email"
                        class="form-input"
                        placeholder="john@example.com"
                        value="${API.escapeHtml(prefill.email || '')}"
                        autocomplete="off">
                </div>

                <div class="form-row">
                    <label for="${this.id}-phone">Phone</label>
                    <input
                        type="tel"
                        id="${this.id}-phone"
                        class="form-input"
                        placeholder="+1 (555) 123-4567"
                        value="${API.escapeHtml(prefill.phone || '')}"
                        autocomplete="off">
                </div>

                <div class="form-row">
                    <label for="${this.id}-company">Company</label>
                    <input
                        type="text"
                        id="${this.id}-company"
                        class="form-input"
                        placeholder="ACME Corp"
                        value="${API.escapeHtml(prefill.company || '')}"
                        autocomplete="off">
                </div>

                <div class="form-row">
                    <label for="${this.id}-position">Position</label>
                    <input
                        type="text"
                        id="${this.id}-position"
                        class="form-input"
                        placeholder="VP of Sales"
                        value="${API.escapeHtml(prefill.position || '')}"
                        autocomplete="off">
                </div>

                <div class="form-row-split">
                    <div class="form-row">
                        <label for="${this.id}-source">Source</label>
                        <select id="${this.id}-source" class="form-input">
                            <option value="">Select source...</option>
                            <option value="website">Website</option>
                            <option value="referral">Referral</option>
                            <option value="cold_call">Cold Call</option>
                            <option value="linkedin">LinkedIn</option>
                            <option value="facebook">Facebook</option>
                            <option value="email">Email Campaign</option>
                            <option value="event">Event</option>
                            <option value="other">Other</option>
                        </select>
                    </div>

                    <div class="form-row">
                        <label for="${this.id}-quality">Quality Score</label>
                        <input
                            type="number"
                            id="${this.id}-quality"
                            class="form-input"
                            min="1"
                            max="10"
                            placeholder="7"
                            value="${prefill.quality_score || ''}">
                    </div>
                </div>

                <div class="form-row">
                    <label for="${this.id}-notes">Notes</label>
                    <textarea
                        id="${this.id}-notes"
                        class="form-input"
                        rows="3"
                        placeholder="Quick notes about this lead...">${API.escapeHtml(prefill.notes || '')}</textarea>
                </div>
            </form>

            <style>
                .quick-add-form {
                    display: flex;
                    flex-direction: column;
                    gap: 1rem;
                }

                .form-row {
                    display: flex;
                    flex-direction: column;
                    gap: 0.5rem;
                }

                .form-row-split {
                    display: grid;
                    grid-template-columns: 1fr 1fr;
                    gap: 1rem;
                }

                .form-row label {
                    font-weight: 600;
                    font-size: 0.875rem;
                    color: var(--text-primary);
                }

                .form-input {
                    padding: 0.75rem;
                    border: 1px solid var(--border);
                    border-radius: var(--radius);
                    background: var(--surface);
                    color: var(--text-primary);
                    font-size: 0.9375rem;
                    font-family: inherit;
                    transition: var(--transition);
                }

                .form-input:focus {
                    outline: none;
                    border-color: var(--primary);
                    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
                }

                @media (max-width: 768px) {
                    .form-row-split {
                        grid-template-columns: 1fr;
                    }
                }
            </style>
        `;
    }

    hasFooter() {
        return true;
    }

    renderFooter() {
        return `
            <button class="steady-btn steady-btn-secondary" onclick="OverlayManager.close('${this.id}')">
                Cancel
            </button>
            <button class="steady-btn steady-btn-primary" id="${this.id}-submit">
                Add Lead
            </button>
        `;
    }

    onBodyUpdate() {
        // Attach submit handler
        const submitBtn = document.getElementById(`${this.id}-submit`);
        if (submitBtn) {
            submitBtn.onclick = () => this.handleSubmit();
        }

        // Submit on Enter in form
        const form = document.getElementById(`${this.id}-form`);
        if (form) {
            form.onsubmit = (e) => {
                e.preventDefault();
                this.handleSubmit();
            };
        }

        // Focus first input
        const nameInput = document.getElementById(`${this.id}-name`);
        if (nameInput) {
            setTimeout(() => nameInput.focus(), 100);
        }
    }

    async handleSubmit() {
        const getName = () => document.getElementById(`${this.id}-name`).value.trim();
        const getEmail = () => document.getElementById(`${this.id}-email`).value.trim();
        const getPhone = () => document.getElementById(`${this.id}-phone`).value.trim();
        const getCompany = () => document.getElementById(`${this.id}-company`).value.trim();
        const getPosition = () => document.getElementById(`${this.id}-position`).value.trim();
        const getSource = () => document.getElementById(`${this.id}-source`).value;
        const getQuality = () => document.getElementById(`${this.id}-quality`).value;
        const getNotes = () => document.getElementById(`${this.id}-notes`).value.trim();

        const name = getName();

        if (!name) {
            SteadyUtils.shake(`#${this.id}-name`);
            toast('Name is required', 'error');
            return;
        }

        const submitBtn = document.getElementById(`${this.id}-submit`);
        submitBtn.disabled = true;
        submitBtn.textContent = 'Adding...';

        try {
            const leadData = {
                name,
                email: getEmail() || null,
                phone: getPhone() || null,
                company: getCompany() || null,
                position: getPosition() || null,
                source: getSource() || null,
                quality_score: getQuality() ? parseInt(getQuality()) : null,
                notes: getNotes() || null,
                status: 'new',
                type: 'cold'
            };

            // Check duplicates
            const dupes = await API.checkDuplicates(leadData);

            if (dupes.hasExactDuplicates) {
                const confirmed = confirm(`This lead looks like a duplicate:\n\n${dupes.exact[0].lead.name} - ${dupes.exact[0].lead.company}\n\nAdd anyway?`);
                if (!confirmed) {
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Add Lead';
                    return;
                }
            }

            // Create lead
            await API.createLead(leadData);

            toast('Lead added successfully! 🎉', 'success');

            // Close overlay
            OverlayManager.close(this.id);

            // Reload current page to show new lead
            if (window.loadPage) {
                const currentPage = document.querySelector('.nav-link.active')?.getAttribute('data-page') || 'dashboard';
                window.loadPage(currentPage);
            }

        } catch (error) {
            console.error('Quick add error:', error);
            toast(API.handleAPIError(error, 'Quick Add Lead'), 'error');
            submitBtn.disabled = false;
            submitBtn.textContent = 'Add Lead';
        }
    }
}

// Register this overlay type
OverlayManager.register('quick-add-lead', QuickAddLeadOverlay);

console.log('QuickAddLeadOverlay registered ✅');
    </script>
    <!-- Pro Tier Modules -->
    <script src="/dashboard/tiers/professional/scripts/dashboard.js"></script>
    <script src="/dashboard/tiers/professional/scripts/AddLead.js"></script>
    <script src="/dashboard/tiers/professional/scripts/PipelineRevolution.js"></script>
    <script src="/dashboard/tiers/professional/scripts/Settings.js"></script>
    <!-- Jobs and Goals modules coming soon -->
</body>
</html>